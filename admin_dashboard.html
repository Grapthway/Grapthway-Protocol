
<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grapthway Node Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/elliptic/6.5.4/elliptic.min.js"></script>
    <style>
        :root {
            --primary: #2563eb; /* Updated to blue-600 for better visibility */
            --secondary: #10b981; --dark: #1f2937;
            --light: #f9fafb; --gray: #6b7280; --danger: #ef4444; --warning: #f59e0b;
        }
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; }
        .tab.active { border-color: var(--primary); color: var(--primary); background-color: white; }
        .sub-tab.active, .token-nav-link.active { border-color: var(--primary); color: var(--primary); background-color: #eff6ff; }
        .log-container { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; }
        #login-modal, #details-modal, #wallet-creation-modal, #create-token-modal { background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .modal-content { animation: fadeIn 0.2s ease-out; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; }
        .log-entry.open .collapsible-content, .workflow-instance.open .collapsible-content, .developer-group.open .collapsible-content { max-height: 8000px; }
        .developer-header:hover .group-chevron { transform: translateY(1px); }
        .log-entry.open .group-chevron, .workflow-instance.open .group-chevron, .developer-group.open .group-chevron { transform: rotate(180deg); }
        .diff-line { display: block; white-space: pre; }
        .diff-line.added { background-color: rgba(16, 185, 129, 0.1); color: #059669; }
        .diff-line.removed { background-color: rgba(239, 68, 68, 0.1); color: #dc2626; }
        .progress-bar { background-color: #e5e7eb; border-radius: 0.5rem; overflow: hidden; height: 1rem; }
        .progress-bar-inner { height: 100%; border-radius: 0.5rem; transition: width 0.5s ease-in-out; }
        #token-selector-dropdown { max-height: 200px; }
    </style>
</head>
<body class="h-full bg-gray-100 text-gray-800">

    <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md transform transition-all modal-content relative">
            <div class="text-center">
                <div class="mx-auto bg-blue-100 h-16 w-16 flex items-center justify-center rounded-full">
                    <i data-lucide="shield-check" class="w-10 h-10 text-blue-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-dark mt-4">Node Access</h2>
                <p class="text-gray mt-2">Enter a node URL and your Private Key to connect.</p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div>
                    <label for="node-url" class="text-sm font-medium text-gray-700">Node URL</label>
                    <div class="mt-1 relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="server" class="w-5 h-5 text-gray-400"></i></div>
                        <input type="text" id="node-url" placeholder="http://localhost:5000" required class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-600 focus:border-blue-600">
                    </div>
                </div>
                <div>
                    <label for="private-key" class="text-sm font-medium text-gray-700">Your Private Key</label>
                     <div class="mt-1 relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="key-round" class="w-5 h-5 text-gray-400"></i></div>
                        <input type="password" id="private-key" placeholder="Enter your hex private key" required class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-600 focus:border-blue-600">
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-600 transition-colors">Connect</button>
            </form>
        </div>
    </div>

    <div id="details-modal" class="fixed inset-0 z-40 flex items-center justify-center p-4 hidden" onclick="closeDetailsModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto modal-content relative" onclick="event.stopPropagation()">
            <button onclick="closeDetailsModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <div id="details-modal-content" class="p-8"></div>
        </div>
    </div>
    
    <!-- Wallet Creation Modal -->
    <div id="wallet-creation-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div id="wallet-creation-modal-content" class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg transform transition-all modal-content relative">
            <!-- Content will be injected by JavaScript -->
        </div>
    </div>

    <!-- Create Token Modal -->
     <div id="create-token-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div id="create-token-modal-content" class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl transform transition-all modal-content relative max-h-[90vh] overflow-y-auto">
             <!-- Content will be injected by JavaScript -->
        </div>
    </div>


    <div id="main-content" class="container mx-auto p-4 md:p-6 lg:p-8 hidden relative">
        <div id="logout-container" class="absolute top-4 right-4 md:top-6 md:right-8">
            <button id="logout-button" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors flex items-center">
                <i data-lucide="log-out" class="w-5 h-5 mr-2"></i>Logout
            </button>
        </div>

        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-dark tracking-tight"><i data-lucide="network" class="inline-block w-10 h-10 mr-2 text-blue-600"></i> Grapthway Node Monitor</h1>
            <p id="auth-level-indicator" class="text-lg text-gray mt-2"></p>
        </header>

        <div id="tabs-container" class="tabs flex border-b border-gray-200 mb-6 overflow-x-auto"></div>

        <div class="tab-content fade-in" id="status-tab"></div>
        <div class="tab-content hidden fade-in" id="hardware-tab"></div>
        <div class="tab-content hidden fade-in" id="services-tab"></div>
        <div class="tab-content hidden fade-in" id="pipelines-tab"></div>
        <div class="tab-content hidden fade-in" id="workflows-tab"></div>
        <div class="tab-content hidden fade-in" id="wallet-tab"></div>
        <div class="tab-content hidden fade-in" id="logging-tab"></div>
    </div>

    <script>
        // --- App State & Config ---
        let config = { nodeUrl: '', privateKey: '', identity: null, authLevel: 'none' };
        let state = { 
            services: null, pipelines: null, status: null, hardware: null,
            workflows: { registered: null, monitored: [] },
            search: { services: '', pipelines: '', workflows: '', logs: {}, wallet: '' },
            logs: {
                gateway: { data: [], filtered: [], currentPage: 1, logsPerPage: 20, query: '', serviceFilter: 'all' },
                schema: { data: [], filtered: [], currentPage: 1, logsPerPage: 20, query: '', serviceFilter: 'all' },
                admin: { data: [], filtered: [], currentPage: 1, logsPerPage: 20, query: '' },
                ledger: { data: [], filtered: [], currentPage: 1, logsPerPage: 20, query: '' }
            },
            wallet: {
                history: [],
                currentPage: 1,
                totalPages: 1,
                searchPage: 1,
                limit: 10,
                timeframeFilter: '24h',
                allowanceSpender: '',
                stakeInfo: null,
                tokens: {
                    list: [],
                    selected: null,
                    selectedTokenInfo: null,
                    searchTerm: '',
                    selectorOpen: false,
                    detailsCache: {} // Cache for token info to use in history
                }
            },
            live: { logTypeFilter: 'all', serviceFilter: 'all' },
            monitoringFilters: { name: '', status: '', startDate: '' }
        };
        let logSocket;
        let fetchInterval;
        const ec = new elliptic.ec('secp256k1');

        let loginModal, loginForm, mainContent, detailsModal, detailsModalContent;

        // --- Utility Functions ---
        const deepEqual = (a, b) => {
            if (a === b) return true;
            if (a && b && typeof a === 'object' && typeof b === 'object') {
                if (a.constructor !== b.constructor) return false;
                let length, i, keys;
                if (Array.isArray(a)) {
                    length = a.length;
                    if (length !== b.length) return false;
                    for (i = length; i-- > 0;) {
                        if (!deepEqual(a[i], b[i])) return false;
                    }
                    return true;
                }
                if (a.constructor === Object) {
                    keys = Object.keys(a);
                    length = keys.length;
                    if (length !== Object.keys(b).length) return false;
                    for (i = length; i-- > 0;) {
                        if (!Object.prototype.hasOwnProperty.call(b, keys[i])) return false;
                    }
                    for (i = length; i-- > 0;) {
                        const key = keys[i];
                        if (!deepEqual(a[key], b[key])) return false;
                    }
                    return true;
                }
            }
            return a !== a && b !== b;
        };

        const apiFetch = async (endpoint, options = {}) => {
            const { authType = 'public', body } = options;
            let apiPrefix = '/public';
            const headers = { 'Content-Type': 'application/json', ...options.headers };
            
            if (authType === 'user' || authType === 'admin') {
                let pathPrefix = authType === 'admin' ? '/admin' : '/api/v1';
                // Token routes are under /api/v1, not /admin, even for admins
                if(endpoint.startsWith('/token/')) {
                    pathPrefix = '/api/v1';
                }
                apiPrefix = pathPrefix;
                
                let dataToSign;
                if (authType === 'admin') {
                    // Admin auth signs the admin's own address
                    dataToSign = config.identity.address;
                } else { // 'user' auth
                    if (options.method === 'GET' || !body) {
                        // For GET requests, sign the path.
                         dataToSign = `${apiPrefix}${endpoint}`;
                    } else {
                        // For POST requests, sign the body.
                        dataToSign = JSON.stringify(body);
                    }
                }

                const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(dataToSign));
                const signature = config.identity.key.sign(Array.from(new Uint8Array(hash)));
                const signatureHex = signature.toDER('hex');

                if (authType === 'admin') {
                    headers['X-Grapthway-Admin-Address'] = config.identity.address;
                    headers['X-Grapthway-Admin-Signature'] = signatureHex;
                }
                
                // ALL authenticated requests need user headers for identity
                headers['X-Grapthway-User-Address'] = config.identity.address;
                headers['X-Grapthway-User-PublicKey'] = config.identity.publicKey;
                headers['X-Grapthway-User-Signature'] = signatureHex;
                headers['X-Grapthway-Developer-ID'] = config.identity.address;

            }

            const url = `${config.nodeUrl}${apiPrefix}${endpoint}`;
            
            try {
                const response = await fetch(url, {
                    method: body ? 'POST' : 'GET',
                    headers: headers,
                    body: body ? JSON.stringify(body) : null
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    if (authType === 'admin' && (response.status === 401 || response.status === 403)) {
                        const statusCheck = await apiFetch('/gateway-status', { authType: 'public' });
                        if(statusCheck) {
                           return { error: 'admin_auth_failed', status: response.status, message: errorText };
                        }
                    }
                    throw new Error(`HTTP error! Status: ${response.status} on ${url} - ${errorText}`);
                }
                const text = await response.text();
                if (text === "") return {};
                return JSON.parse(text);
            } catch (error) {
                console.error(`Failed to fetch ${endpoint}:`, error);
                if (error.message.includes('403')) {
                    return { error: 'admin_auth_failed', status: 403, message: error.message };
                }
                return { error: 'network_failure', message: error.message };
            }
        };
        
        const generateIdentityFromKey = async (privKeyHex) => {
            try {
                const cleanHex = privKeyHex.startsWith('0x') ? privKeyHex.substring(2) : privKeyHex;
                const key = ec.keyFromPrivate(cleanHex, 'hex');
                const pubKeyHex = key.getPublic('hex');
                const pubKeyBytesWithPrefix = new Uint8Array(pubKeyHex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
                const pubKeyBytes = pubKeyBytesWithPrefix.slice(1);
                const hashBuffer = await crypto.subtle.digest('SHA-256', pubKeyBytes);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                const address = '0x' + hashHex.slice(-40);
                return { key, address, publicKey: pubKeyHex };
            } catch (e) {
                console.error("Invalid private key:", e);
                return null;
            }
        };

        const copyToClipboard = async (text, button) => {
            try {
                await navigator.clipboard.writeText(text);
                
                // Visual feedback
                const originalHTML = button.innerHTML;
                button.innerHTML = `<span class="text-green-600 font-medium">Copied!</span>`;
                button.classList.add('bg-green-50');
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('bg-green-50');
                }, 500);
            } catch (err) {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard');
            }
        };
        
        const renderIcon = (iconName, classes = "w-5 h-5") => {
            const icon = lucide.icons[iconName];
            return icon ? icon.toSvg({ class: classes }) : '';
        };
        
        const formatBytes = (bytes, decimals = 2) => {
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        };

        const safeJsonParse = (str) => {
            if (typeof str !== 'string' || !str.trim().startsWith('{')) return str;
            try { return JSON.parse(str); } catch (e) { return str; }
        };

        const syntaxHighlight = (data) => {
            if (data === null || data === undefined) return '<span class="text-gray-500">null</span>';
            const parsedData = (typeof data === 'string') ? safeJsonParse(data) : data;
            let jsonString = JSON.stringify(parsedData, undefined, 2);

            jsonString = jsonString.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return jsonString.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, (match) => {
                let cls = 'text-green-400';
                if (/^"/.test(match)) cls = /:$/.test(match) ? 'text-sky-300' : 'text-amber-300';
                else if (/true|false/.test(match)) cls = 'text-purple-400';
                else if (/null/.test(match)) cls = 'text-gray-500';
                return `<span class="${cls}">${match}</span>`;
            });
        };
        
        const generateDiff = (before, after) => {
            const diff = Diff.createTwoFilesPatch('schema-before', 'schema-after', before || '', after || '', null, null, { context: 2 });
            const lines = diff.split('\n').slice(4);
            if (lines.every(line => !line.startsWith('+') && !line.startsWith('-'))) return '<div class="text-gray-500">No changes detected.</div>';
            return lines.map(line => {
                const escapedLine = line.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                if (line.startsWith('+')) return `<span class="diff-line added">${escapedLine.substring(1)}</span>`;
                if (line.startsWith('-')) return `<span class="diff-line removed">${escapedLine.substring(1)}</span>`;
                return `<span class="diff-line neutral">${escapedLine}</span>`;
            }).join('\n');
        };

        const showDetailsModal = (title, content) => {
            detailsModalContent.innerHTML = `<h2 class="text-2xl font-bold text-dark mb-6">${title}</h2>${content}`;
            detailsModal.classList.remove('hidden');
            lucide.createIcons();
        };

        const closeDetailsModal = () => detailsModal.classList.add('hidden');

        const showWalletCreationModal = () => {
            const modal = document.getElementById('wallet-creation-modal');
            const modalContent = document.getElementById('wallet-creation-modal-content');

            // Step 1: Show Confirmation
            modalContent.innerHTML = `
                <div class="text-center">
                    <div class="mx-auto bg-yellow-100 h-16 w-16 flex items-center justify-center rounded-full">
                        <i data-lucide="alert-triangle" class="w-10 h-10 text-yellow-500"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-dark mt-4">Create New Wallet?</h2>
                    <p class="text-gray mt-2">
                        This will generate a new wallet on the node. The private key will be shown only once. 
                        Please ensure you save it securely.
                    </p>
                </div>
                <div class="mt-8 flex justify-center space-x-4">
                    <button id="cancel-wallet-creation" 
                            class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-md hover:bg-gray-300">
                        Cancel
                    </button>
                    <button id="confirm-wallet-creation" 
                            class="bg-blue-600 text-white font-bold py-2 px-6 rounded-md hover:bg-blue-700">
                        Yes, Create Wallet
                    </button>
                </div>
            `;

            modal.classList.remove('hidden');
            lucide.createIcons();

            document.getElementById('cancel-wallet-creation').addEventListener('click', hideWalletCreationModal);
            document.getElementById('confirm-wallet-creation').addEventListener('click', async (e) => {
                const proceedButton = e.currentTarget;
                proceedButton.disabled = true;
                proceedButton.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-5 h-5 mx-auto"></i>`;
                lucide.createIcons();

                // Step 2: Call API
                const newWallet = await apiFetch('/wallet/create', { authType: 'admin', method: 'POST', body: {} });

                // Step 3: Show Result
                if (newWallet && newWallet.privateKey) {
                    modalContent.innerHTML = `
                        <div class="text-center">
                            <div class="mx-auto bg-green-100 h-16 w-16 flex items-center justify-center rounded-full">
                                <i data-lucide="check-circle" class="w-10 h-10 text-green-500"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-dark mt-4">Wallet Created Successfully!</h2>
                            <p class="text-red-600 font-bold mt-2 bg-red-100 p-2 rounded-md">SAVE YOUR PRIVATE KEY. It will not be shown again.</p>
                        </div>
                        <div class="mt-6 space-y-4">
                            <div>
                                <label class="text-sm font-medium text-gray-700">Address</label>
                                <div class="mt-1 flex items-center bg-gray-100 p-2 rounded-md">
                                    <input readonly class="font-mono text-sm bg-transparent w-full outline-none" value="${newWallet.address}">
                                    <button onclick="copyToClipboard('${newWallet.address}', this)" class="p-1 text-gray-500 hover:text-blue-600 flex-shrink-0">${renderIcon('copy', 'w-5 h-5')}</button>
                                </div>
                            </div>
                             <div>
                                <label class="text-sm font-medium text-gray-700">Private Key</label>
                                <div class="mt-1 flex items-center bg-gray-100 p-2 rounded-md">
                                    <input readonly class="font-mono text-sm bg-transparent w-full outline-none" value="${newWallet.privateKey}">
                                     <button onclick="copyToClipboard('${newWallet.privateKey}', this)" class="p-1 text-gray-500 hover:text-blue-600 flex-shrink-0">${renderIcon('copy', 'w-5 h-5')}</button>
                                </div>
                            </div>
                        </div>
                         <div class="mt-8 flex justify-end">
                            <button id="close-wallet-modal" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">Done</button>
                        </div>
                    `;
                    document.getElementById('close-wallet-modal').addEventListener('click', hideWalletCreationModal);

                } else { // Handle failure
                    modalContent.innerHTML = `
                         <div class="text-center">
                            <div class="mx-auto bg-red-100 h-16 w-16 flex items-center justify-center rounded-full">
                                <i data-lucide="x-circle" class="w-10 h-10 text-red-500"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-dark mt-4">Failed to Create Wallet</h2>
                            <p class="text-gray-600 mt-2">${newWallet.message || 'The node could not create a new wallet. Check the node logs for more details.'}</p>
                        </div>
                        <div class="mt-8 flex justify-end">
                            <button id="close-wallet-modal" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300">Close</button>
                        </div>
                    `;
                     document.getElementById('close-wallet-modal').addEventListener('click', hideWalletCreationModal);
                }
                lucide.createIcons();
            });
        };

        const hideWalletCreationModal = () => {
            document.getElementById('wallet-creation-modal').classList.add('hidden');
        };
        
        const showCreateTokenModal = () => {
            const modal = document.getElementById('create-token-modal');
            const modalContent = document.getElementById('create-token-modal-content');
            modalContent.innerHTML = `
                <button onclick="hideCreateTokenModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                <h2 class="text-2xl font-bold text-dark mb-6">Create New Token</h2>
                <form id="token-create-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-medium text-gray-700">Token Name</label>
                            <input name="name" required placeholder="e.g., MyCoin" class="mt-1 w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700">Ticker</label>
                            <input name="ticker" required placeholder="e.g., MYC" class="mt-1 w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700">Decimals</label>
                            <input name="decimals" type="number" min="0" max="6" value="6" required class="mt-1 w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700">Initial Supply</label>
                            <input name="initialSupply" type="number" step="any" required placeholder="e.g., 1000000" class="mt-1 w-full p-2 border rounded-md">
                        </div>
                         <div class="md:col-span-2">
                            <label class="text-sm font-medium text-gray-700">Token Type</label>
                            <select name="tokenType" class="mt-1 w-full p-2 border rounded-md bg-white">
                                <option value="FUNGIBLE">Fungible</option>
                                <option value="RWA">Real World Asset</option>
                                <option value="NFT" disabled>Non-Fungible (Future)</option>
                            </select>
                        </div>
                    </div>
                    <div class="pt-4 border-t">
                        <label class="text-sm font-medium text-gray-700">Metadata (Required)</label>
                        <textarea name="metadata" required placeholder='JSON or URL (e.g., {"description":"My token!"})' class="mt-1 w-full p-2 border rounded-md h-24 font-mono text-xs"></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t">
                        <div class="space-y-2">
                             <h4 class="font-semibold text-dark">Minting Configuration</h4>
                             <label class="flex items-center gap-2"><input type="checkbox" name="mintConfigEnabled"> Enable Minting</label>
                             <label class="flex items-center gap-2"><input type="checkbox" name="mintConfigManualMint" checked> Allow Manual Minting</label>
                        </div>
                         <div class="space-y-2">
                             <h4 class="font-semibold text-dark">Burning Configuration</h4>
                             <label class="flex items-center gap-2"><input type="checkbox" name="burnConfigEnabled"> Enable Burning</label>
                             <label class="flex items-center gap-2"><input type="checkbox" name="burnConfigManualBurn" checked> Allow Manual Burning</label>
                        </div>
                    </div>

                    <div class="pt-6 flex justify-end">
                        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-md hover:bg-blue-700 flex items-center justify-center gap-2">
                            ${renderIcon('plus', 'w-5 h-5')}Create Token
                        </button>
                    </div>
                </form>
            `;
            modal.classList.remove('hidden');
            lucide.createIcons();
            setupTokenTransactionForm('token-create-form', '/token/create', true);
        };
        const hideCreateTokenModal = () => {
             document.getElementById('create-token-modal').classList.add('hidden');
        };

        // --- Rendering Functions ---
        const renderTabs = () => {
             const tabsContainer = document.getElementById('tabs-container');
            const allTabs = [
                { id: 'status', icon: 'activity', label: 'Status', level: 'public' },
                { id: 'hardware', icon: 'hard-drive', label: 'Hardware', level: 'public' },
                { id: 'services', icon: 'server-cog', label: 'Services', level: 'public' },
                { id: 'pipelines', icon: 'milestone', label: 'Pipelines', level: 'public' },
                { id: 'workflows', icon: 'workflow', label: 'Workflows', level: 'user' },
                { id: 'wallet', icon: 'wallet', label: 'Wallet', level: 'user' },
                { id: 'logging', icon: 'terminal', label: 'Logging', level: 'user' }
            ];

            const visibleTabs = allTabs.filter(tab => {
                if (tab.level === 'public') return true;
                if (tab.level === 'user' && (config.authLevel === 'user' || config.authLevel === 'admin')) return true;
                return false;
            });

            tabsContainer.innerHTML = visibleTabs.map(tab => `
                <button class="tab flex-1 py-4 px-2 text-center font-semibold text-gray-500 hover:bg-gray-50 border-b-2 border-transparent transition whitespace-nowrap" data-tab="${tab.id}">
                    <i data-lucide="${tab.icon}" class="inline-block w-5 h-5 mr-2"></i>${tab.label}
                </button>
            `).join('');

            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    tab.classList.add('active');
                    const tabContentId = `${tab.dataset.tab}-tab`;
                    document.getElementById(tabContentId).classList.remove('hidden');
                    
                    // Always re-render the content when the tab is clicked to ensure data is fresh.
                    if (tab.dataset.tab === 'wallet') renderWallet();
                    if (tab.dataset.tab === 'workflows') renderWorkflows();
                    if (tab.dataset.tab === 'logging') renderLogging();
                });
            });
        };
        
        const renderStatus = (data) => {
            const container = document.getElementById('status-tab');
            if (!data) {
                container.innerHTML = `<div class="text-center p-12 text-gray-500"><div class="text-3xl mb-4">${renderIcon('cloud-off')}</div>Could not fetch node status.</div>`;
                lucide.createIcons(); return;
            }
            const uptime = data.uptime || '0s';
            const stats = [
                { icon: 'server', label: 'Services', value: data.total_services || 0 },
                { icon: 'server-cog', label: 'Instances', value: data.total_instances || 0 },
                { icon: 'milestone', label: 'Pipelines', value: data.total_pipelines || 0 },
                { icon: 'box-select', label: 'Subgraphs', value: data.total_subgraphs || 0 },
            ];
            
            const peers = data.peers || [];
            const peerCount = peers.length;

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">${stats.map(stat => `
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
                        <div class="bg-blue-100 text-blue-600 p-3 rounded-full">${renderIcon(stat.icon, 'w-8 h-8')}</div>
                        <div>
                            <p class="text-gray-500 font-medium">${stat.label}</p>
                            <p class="text-3xl font-bold text-dark">${stat.value}</p>
                        </div>
                    </div>`).join('')}
                </div>
                <div class="mt-8 bg-white p-6 rounded-xl shadow-md flex justify-between items-center flex-wrap gap-4">
                    <div class="flex items-center space-x-4">
                        <div class="text-green-500">${renderIcon('shield-check', 'w-8 h-8')}</div>
                        <div>
                            <p class="font-bold text-lg text-dark">Node Operational</p>
                            <p class="text-gray-600">Storage: <span class="font-semibold capitalize">${data.storage_type || 'N/A'}</span></p>
                        </div>
                    </div>
                    <div>
                        <p class="text-gray-500">Uptime</p>
                        <p class="font-mono text-lg font-semibold text-dark">${uptime.replace(/(\.\d{3})\d+/, '$1')}</p>
                    </div>
                </div>
                <div class="mt-8 bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-bold text-dark mb-4 flex items-center">
                        ${renderIcon('info', 'w-6 h-6 mr-3 text-blue-600')} Node & Network Information
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <div class="space-y-4">
                            <div>
                                <p class="text-sm font-medium text-gray-500">Node Peer ID</p>
                                <div class="flex items-center space-x-2">
                                    <p class="font-mono text-gray-700 truncate" id="node-id-text">${data.node_id || 'N/A'}</p>
                                    <button onclick="copyToClipboard('${data.node_id || ''}', this)" class="p-1 text-gray-400 hover:text-blue-600">${renderIcon('copy', 'w-4 h-4')}</button>
                                </div>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Node Owner Address</p>
                                <div class="flex items-center space-x-2">
                                    <p class="font-mono text-gray-700 truncate" id="node-address-text">${data.node_address || 'N/A'}</p>
                                     <button onclick="copyToClipboard('${data.node_address || ''}', this)" class="p-1 text-gray-400 hover:text-blue-600">${renderIcon('copy', 'w-4 h-4')}</button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Connected Peers (${peerCount})</p>
                            <div class="mt-2 bg-gray-50 p-3 rounded-lg h-24 overflow-y-auto border">
                                ${peerCount > 0 ? peers.map(p => `<p class="font-mono text-xs text-gray-600 truncate" title="${p}">${p}</p>`).join('') : '<p class="text-sm text-gray-400">No peers connected.</p>'}
                            </div>
                        </div>
                    </div>
                </div>`;
             lucide.createIcons();
        };
        
        const renderHardware = (data) => {
            const container = document.getElementById('hardware-tab');
            if (!data || !data.local || !data.global) {
                container.innerHTML = `<div class="text-center p-12 text-gray-500"><div class="text-3xl mb-4">${renderIcon('server-off')}</div>Could not fetch hardware stats.</div>`;
                lucide.createIcons(); return;
            }
            const { local, global } = data;
            const cpuCores = local.cgroup_limits.cpu_quota_cores;
            const memLimit = local.cgroup_limits.memory_limit_bytes;
            const memLimitText = (memLimit > 0 && memLimit < 1e18) ? formatBytes(memLimit) : 'Unlimited';
            
            const cpuPercent = local.usage.cpu_total_usage_percent || 0;
            const ramPercent = local.usage.ram_usage_percent || 0;
            
            const globalCpuPercent = global.average_cpu_usage_percent || 0;
            const globalRamPercent = global.total_ram_bytes > 0 ? (global.used_ram_bytes / global.total_ram_bytes) * 100 : 0;

            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-2xl font-bold text-dark mb-6 flex items-center"><i data-lucide="monitor" class="w-7 h-7 mr-3 text-blue-600"></i>Local Node Monitoring</h2>
                        <div class="space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <h3 class="text-lg font-bold text-dark mb-4 flex items-center"><i data-lucide="box" class="w-6 h-6 mr-3 text-blue-600"></i>Container Allocation</h3>
                                <div class="space-y-4 text-gray-700">
                                    <div class="flex items-center">${renderIcon('cpu', 'w-5 h-5 mr-2 text-gray-500')}<span class="font-semibold">CPU Cores Allocated:</span><span class="ml-2 font-mono text-lg font-bold text-dark">${cpuCores > 0 ? cpuCores.toFixed(2) : 'Unlimited'}</span></div>
                                    <div class="flex items-center">${renderIcon('memory-stick', 'w-5 h-5 mr-2 text-gray-500')}<span class="font-semibold">Memory Limit:</span><span class="ml-2 font-mono text-lg font-bold text-dark">${memLimitText}</span></div>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <h3 class="text-lg font-bold text-dark mb-4 flex items-center"><i data-lucide="activity" class="w-6 h-6 mr-3 text-secondary"></i>Live Usage</h3>
                                <div class="space-y-4">
                                    <div>
                                        <div class="flex justify-between items-center mb-1"><span class="font-semibold">CPU Usage</span><span class="font-mono text-blue-600">${cpuPercent.toFixed(1)}% (${local.usage.cpu_used_cores.toFixed(2)} cores)</span></div>
                                        <div class="progress-bar"><div class="progress-bar-inner bg-blue-600" style="width: ${cpuPercent}%"></div></div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between items-center mb-1"><span class="font-semibold">Memory Usage</span><span class="font-mono text-blue-600">${formatBytes(local.usage.ram_used_bytes)} / ${formatBytes(local.usage.ram_total_bytes)}</span></div>
                                        <div class="progress-bar"><div class="progress-bar-inner bg-blue-600" style="width: ${ramPercent}%"></div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-dark mb-6 flex items-center"><i data-lucide="globe-2" class="w-7 h-7 mr-3 text-secondary"></i>Global Network Statistics</h2>
                        <div class="space-y-6">
                             <div class="bg-white p-6 rounded-xl shadow-md">
                                <h3 class="text-lg font-bold text-dark mb-4 flex items-center"><i data-lucide="network" class="w-6 h-6 mr-3 text-secondary"></i>Network Composition</h3>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between"><span class="font-semibold">Total Nodes:</span><span class="font-mono text-lg font-bold text-dark">${global.total_nodes}</span></div>
                                    <div class="flex items-center justify-between pl-4"><span class="text-gray-600">Servers:</span><span class="font-mono text-md font-semibold text-gray-800">${global.total_servers}</span></div>
                                    <div class="flex items-center justify-between pl-4"><span class="text-gray-600">Workers:</span><span class="font-mono text-md font-semibold text-gray-800">${global.total_workers}</span></div>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <h3 class="text-lg font-bold text-dark mb-4 flex items-center"><i data-lucide="cpu" class="w-6 h-6 mr-3 text-secondary"></i>Global CPU & RAM</h3>
                                <div class="space-y-4">
                                    <div>
                                        <div class="flex justify-between items-center mb-1"><span class="font-semibold">Avg. CPU Usage</span><span class="font-mono text-secondary">${globalCpuPercent.toFixed(1)}%</span></div>
                                        <div class="progress-bar"><div class="progress-bar-inner bg-secondary" style="width: ${globalCpuPercent}%"></div></div>
                                        <div class="text-sm text-center mt-2 text-gray-600 font-mono">${global.total_used_cores.toFixed(2)} / ${global.total_available_cores > 0 ? global.total_available_cores.toFixed(2) : 'âˆž'} Cores Used</div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between items-center mb-1"><span class="font-semibold">Total RAM Usage</span><span class="font-mono text-secondary">${globalRamPercent.toFixed(1)}%</span></div>
                                        <div class="progress-bar"><div class="progress-bar-inner bg-secondary" style="width: ${globalRamPercent}%"></div></div>
                                        <div class="text-sm text-center mt-2 text-gray-600 font-mono">${formatBytes(global.used_ram_bytes)} / ${formatBytes(global.total_ram_bytes)} Used</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            lucide.createIcons();
        };

        const renderServices = (data) => {
            const container = document.getElementById('services-tab');
            if (!data || Object.keys(data).length === 0) {
                container.innerHTML = `<div class="text-center p-12 text-gray-500"><div class="text-3xl mb-4">${renderIcon('server-off')}</div>No services registered.</div>`;
                lucide.createIcons(); return;
            }
            container.innerHTML = `
                <div class="mb-4 relative">
                    <i data-lucide="search" class="w-5 h-5 text-gray-400 absolute top-1/2 left-3 -translate-y-1/2"></i>
                    <input type="text" id="service-search" placeholder="Search by service name or developer address..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-600 focus:border-blue-600">
                </div>
                <div id="services-list" class="space-y-8"></div>`;
            renderFilteredServices();
            lucide.createIcons();
        };

        const renderFilteredServices = () => {
            const container = document.getElementById('services-list');
            if (!container) return;

            const searchTerm = state.search.services.toLowerCase();
            const servicesByDeveloper = {};
            for (const compositeKey in state.services) {
                const instances = state.services[compositeKey];
                if (instances.length > 0) {
                    const devAddress = instances[0].developerAddress;
                    const serviceName = instances[0].service;
                    if (serviceName.toLowerCase().includes(searchTerm) || devAddress.toLowerCase().includes(searchTerm)) {
                        if (!servicesByDeveloper[devAddress]) {
                            servicesByDeveloper[devAddress] = [];
                        }
                        servicesByDeveloper[devAddress].push({ serviceName, instances });
                    }
                }
            }

            if (Object.keys(servicesByDeveloper).length === 0) {
                container.innerHTML = `<div class="text-center p-12 text-gray-500"><div class="text-3xl mb-4">${renderIcon('search-x')}</div>No services match your search.</div>`;
                lucide.createIcons(); return;
            }

            container.innerHTML = Object.entries(servicesByDeveloper).map(([devAddress, services]) => `
                <div class="developer-group open" data-developer-address="${devAddress}">
                    <div class="developer-header flex justify-between items-center bg-gray-200 p-3 rounded-t-lg cursor-pointer" onclick="this.parentElement.classList.toggle('open')">
                        <h2 class="text-lg font-bold text-dark flex items-center">
                            ${renderIcon('user', 'w-5 h-5 mr-3 text-gray-600')}
                            <span class="font-mono text-sm">${devAddress}</span>
                        </h2>
                        <div class="flex items-center gap-4">
                            <span class="bg-gray-600 text-white text-xs font-semibold px-3 py-1 rounded-full">${services.length} Services</span>
                            <i data-lucide="chevron-down" class="w-6 h-6 group-chevron text-gray-600 transition-transform"></i>
                        </div>
                    </div>
                    <div class="collapsible-content bg-white p-4 rounded-b-lg border border-t-0 border-gray-200">
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">${services.map(({ serviceName, instances }) => {
                            const type = instances[0].type || 'unknown';
                            const typeIcon = type === 'rest' ? 'at-sign' : 'box';
                            const typeColor = type === 'rest' ? 'bg-amber-500' : 'bg-sky-500';
                            return `<div class="service-card bg-gray-50 border border-gray-200 rounded-xl shadow-sm overflow-hidden" data-service-name="${serviceName}">
                                <div class="p-4">
                                    <div class="flex justify-between items-center">
                                        <h3 class="font-bold text-lg flex items-center">${renderIcon('cube', 'w-5 h-5 mr-2')}${serviceName}</h3>
                                        <div class="flex items-center gap-2">
                                            <span class="${typeColor} text-white text-xs font-semibold px-3 py-1 rounded-full flex items-center gap-1">${renderIcon(typeIcon, 'w-3 h-3')} ${type}</span>
                                            <span class="bg-blue-600 text-white text-xs font-semibold px-3 py-1 rounded-full">${instances.length} Instances</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-4 pt-0 space-y-2">${instances.map(inst => `
                                    <div class="flex items-center justify-between text-sm p-2 rounded-md bg-white border">
                                        <span class="font-mono text-gray-600 truncate" title="${inst.url}">${renderIcon('link-2', 'w-4 h-4 mr-2 inline-block text-gray-400')}${inst.url}</span>
                                        <div class="w-3 h-3 bg-secondary rounded-full flex-shrink-0 ml-4" title="Healthy since ${new Date(inst.lastSeen).toLocaleString()}"></div>
                                    </div>`).join('')}
                                </div>
                            </div>`
                        }).join('')}</div>
                    </div>
                </div>`).join('');
            lucide.createIcons();
        };
        
        const renderPipelines = (data) => {
            const container = document.getElementById('pipelines-tab');
            if (!data || Object.keys(data).length === 0) {
                container.innerHTML = `<div class="text-center p-12 text-gray-500"><div class="text-3xl mb-4">${renderIcon('milestone')}</div>No pipelines configured.</div>`;
                lucide.createIcons(); return;
            }
            container.innerHTML = `
                <div class="mb-4 relative">
                    <i data-lucide="search" class="w-5 h-5 text-gray-400 absolute top-1/2 left-3 -translate-y-1/2"></i>
                    <input type="text" id="pipeline-search" placeholder="Search by pipeline name or developer address..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-600 focus:border-blue-600">
                </div>
                <div id="pipelines-list" class="space-y-8"></div>`;
            renderFilteredPipelines();
            lucide.createIcons();
        };

        const renderFilteredPipelines = () => {
            const container = document.getElementById('pipelines-list');
            if (!container) return;

            const searchTerm = state.search.pipelines.toLowerCase();
            const pipelinesByDeveloper = {};

            for (const devAddress in state.pipelines) {
                const developerPipelines = state.pipelines[devAddress];
                const filteredPipelines = {};
                let hasMatch = false;

                for (const pipelineKey in developerPipelines) {
                    const config = developerPipelines[pipelineKey];
                    if (config.isWorkflow) continue; 

                    if (pipelineKey.toLowerCase().includes(searchTerm) || devAddress.toLowerCase().includes(searchTerm)) {
                        filteredPipelines[pipelineKey] = config;
                        hasMatch = true;
                    }
                }

                if (hasMatch) {
                    pipelinesByDeveloper[devAddress] = filteredPipelines;
                }
            }

            if (Object.keys(pipelinesByDeveloper).length === 0) {
                container.innerHTML = `<div class="text-center p-12 text-gray-500"><div class="text-3xl mb-4">${renderIcon('search-x')}</div>No pipelines match your search.</div>`;
                lucide.createIcons(); return;
            }

            const renderStep = (step, devAddress, pipelineKey, stepType, index) => `<div class="flex-shrink-0 w-full md:w-64 bg-gray-50 border border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-600 pipeline-step-details-btn" data-dev-address="${devAddress}" data-pipeline-key="${pipelineKey}" data-step-type="${stepType}" data-step-index="${index}"><div class="flex justify-between items-center"><p class="font-bold text-dark flex items-center">${renderIcon('box', 'w-4 h-4 mr-2')}${step.service || 'Workflow'}</p>${step.concurrent ? `<span class="text-xs font-bold text-purple-600 bg-purple-100 px-2 py-1 rounded-full" title="Concurrent">${renderIcon('zap', 'w-3 h-3 inline-block')}</span>` : ''}</div><p class="font-mono text-sm text-gray-600 truncate">${step.field || step.callWorkflow || `${step.method} ${step.path}`}</p><div class="mt-3 pt-3 border-t border-gray-200 text-xs text-gray-500">${renderIcon('info', 'w-3 h-3 mr-1 inline')}Click for details</div></div>`;
            
            container.innerHTML = Object.entries(pipelinesByDeveloper).map(([devAddress, pipelines]) => `
                <div class="developer-group open" data-developer-address="${devAddress}">
                    <div class="developer-header flex justify-between items-center bg-gray-200 p-3 rounded-t-lg cursor-pointer" onclick="this.parentElement.classList.toggle('open')">
                        <h2 class="text-lg font-bold text-dark flex items-center">
                            ${renderIcon('user', 'w-5 h-5 mr-3 text-gray-600')}
                            <span class="font-mono text-sm">${devAddress}</span>
                        </h2>
                         <div class="flex items-center gap-4">
                            <span class="bg-gray-600 text-white text-xs font-semibold px-3 py-1 rounded-full">${Object.keys(pipelines).length} Pipelines</span>
                            <i data-lucide="chevron-down" class="w-6 h-6 group-chevron text-gray-600 transition-transform"></i>
                        </div>
                    </div>
                    <div class="collapsible-content bg-white p-4 rounded-b-lg border border-t-0 border-gray-200 space-y-8">
                        ${Object.entries(pipelines).map(([pipelineKey, config]) => {
                            const hasPre = config.pre && config.pre.length > 0; const hasPost = config.post && config.post.length > 0;
                            return `<div class="pipeline-card bg-gray-50 p-6 rounded-xl border border-gray-200" data-pipeline-key="${pipelineKey}">
                                <h3 class="text-xl font-bold text-dark flex items-center mb-4 border-b pb-3">${renderIcon('git-merge', 'w-6 h-6 mr-3 text-blue-600')}Pipeline for: <span class="font-mono ml-2 p-1 bg-gray-200 rounded-md text-blue-600">${pipelineKey}</span></h3>
                                ${hasPre ? `<div class="mb-6"><h4 class="text-md font-semibold text-gray-700 mb-3 flex items-center">${renderIcon('log-in', 'w-5 h-5 mr-2 text-gray-500')}Pre-flight Steps</h4><div class="flex flex-col md:flex-row items-stretch gap-4 overflow-x-auto pb-4">${config.pre.map((step, index) => `${renderStep(step, devAddress, pipelineKey, 'pre', index)}${index < config.pre.length - 1 ? `<div class="self-center text-gray-300 mx-4 hidden md:block">${renderIcon('chevron-right', 'w-8 h-8')}</div><div class="self-center text-gray-300 my-2 md:hidden">${renderIcon('chevron-down', 'w-8 h-8')}</div>` : ''}`).join('')}</div></div>` : ''}
                                ${hasPost ? `<div><h4 class="text-md font-semibold text-gray-700 mb-3 flex items-center">${renderIcon('log-out', 'w-5 h-5 mr-2 text-gray-500')}Post-flight Enrichment</h4><div class="flex flex-col md:flex-row items-stretch gap-4 overflow-x-auto pb-4">${config.post.map((step, index) => `${renderStep(step, devAddress, pipelineKey, 'post', index)}${index < config.post.length - 1 ? `<div class="self-center text-gray-300 mx-4 hidden md:block">${renderIcon('chevron-right', 'w-8 h-8')}</div><div class="self-center text-gray-300 my-2 md:hidden">${renderIcon('chevron-down', 'w-8 h-8')}</div>` : ''}`).join('')}</div></div>` : ''}
                            </div>`
                        }).join('')}
                    </div>
                </div>`).join('');

            container.querySelectorAll('.pipeline-step-details-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const { devAddress, pipelineKey, stepType, stepIndex } = e.currentTarget.dataset;
                    const step = state.pipelines[devAddress]?.[pipelineKey]?.[stepType]?.[stepIndex];
                    if (step) {
                        const content = `<pre class="bg-dark text-light p-4 rounded-md text-sm whitespace-pre-wrap"><code class="language-json">${syntaxHighlight(step)}</code></pre>`;
                        showDetailsModal(`Pipeline Step: ${step.service || 'Workflow'}/${step.field || step.callWorkflow || step.path}`, content);
                    }
                });
            });
            lucide.createIcons();
        };

        const renderWorkflows = () => {
            const container = document.getElementById('workflows-tab');
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                    <div class="sub-tabs flex border-b border-gray-200 mb-4 overflow-x-auto">
                        <button class="sub-tab flex-1 py-3 px-2 text-center font-semibold text-gray-500 hover:bg-gray-50 border-b-2 border-transparent transition whitespace-nowrap" data-subtab="registered-workflows"><i data-lucide="book-marked" class="inline-block w-5 h-5 mr-2"></i>Registered</button>
                        <button class="sub-tab flex-1 py-3 px-2 text-center font-semibold text-gray-500 hover:bg-gray-50 border-b-2 border-transparent transition whitespace-nowrap" data-subtab="monitoring-workflows"><i data-lucide="bar-chart-3" class="inline-block w-5 h-5 mr-2"></i>Monitoring</button>
                    </div>
                    <div class="sub-tab-content" id="registered-workflows-content"></div>
                    <div class="sub-tab-content hidden" id="monitoring-workflows-content"></div>
                </div>`;
            
            container.querySelectorAll('.sub-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    container.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
                    container.querySelectorAll('.sub-tab-content').forEach(c => c.classList.add('hidden'));
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.subtab}-content`).classList.remove('hidden');
                });
            });

            renderRegisteredWorkflows();
            renderMonitoringWorkflows();
            fetchMonitoredWorkflows();
            
            container.querySelector('.sub-tab').click();
        };

        const renderRegisteredWorkflows = () => {
            const container = document.getElementById('registered-workflows-content');
            if (!container) return;
            
            container.innerHTML = `
                <div class="mb-4 relative">
                    <i data-lucide="search" class="w-5 h-5 text-gray-400 absolute top-1/2 left-3 -translate-y-1/2"></i>
                    <input type="text" id="workflow-search" placeholder="Search by workflow name or developer address..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-600 focus:border-blue-600">
                </div>
                <div id="registered-workflows-list" class="space-y-8"></div>`;
            
            renderFilteredRegisteredWorkflows();
            lucide.createIcons();
        };

        const renderFilteredRegisteredWorkflows = () => {
            const container = document.getElementById('registered-workflows-list');
            if (!container) return;

            const searchTerm = state.search.workflows.toLowerCase();
            const workflowsByDeveloper = {};

            if (state.pipelines) {
                 for (const devAddress in state.pipelines) {
                    const developerPipelines = state.pipelines[devAddress];
                    const filteredWorkflows = {};
                    let hasMatch = false;

                    for (const pipelineKey in developerPipelines) {
                        const config = developerPipelines[pipelineKey];
                        if (!config.isWorkflow) continue;

                        if (pipelineKey.toLowerCase().includes(searchTerm) || devAddress.toLowerCase().includes(searchTerm)) {
                            filteredWorkflows[pipelineKey] = config;
                            hasMatch = true;
                        }
                    }
                    if (hasMatch) {
                        workflowsByDeveloper[devAddress] = filteredWorkflows;
                    }
                }
            }

            if (Object.keys(workflowsByDeveloper).length === 0) {
                container.innerHTML = `<div class="text-center p-12 text-gray-500"><div class="text-3xl mb-4">${renderIcon('search-x')}</div>No workflows match your search.</div>`;
                lucide.createIcons(); return;
            }

            container.innerHTML = Object.entries(workflowsByDeveloper).map(([devAddress, workflows]) => `
                <div class="developer-group open" data-developer-address="${devAddress}">
                    <div class="developer-header flex justify-between items-center bg-gray-200 p-3 rounded-t-lg cursor-pointer" onclick="this.parentElement.classList.toggle('open')">
                         <h2 class="text-lg font-bold text-dark flex items-center">
                            ${renderIcon('user', 'w-5 h-5 mr-3 text-gray-600')}
                            <span class="font-mono text-sm">${devAddress}</span>
                        </h2>
                         <div class="flex items-center gap-4">
                            <span class="bg-gray-600 text-white text-xs font-semibold px-3 py-1 rounded-full">${Object.keys(workflows).length} Workflows</span>
                            <i data-lucide="chevron-down" class="w-6 h-6 group-chevron text-gray-600 transition-transform"></i>
                        </div>
                    </div>
                    <div class="collapsible-content bg-white p-4 rounded-b-lg border border-t-0 border-gray-200">
                        <div class="space-y-6">${Object.entries(workflows).map(([name, config]) => `
                            <div class="workflow-card bg-gray-50 p-6 rounded-xl border border-gray-200" data-workflow-name="${name}">
                                <div class="flex justify-between items-start">
                                    <div><h3 class="text-lg font-bold text-dark flex items-center">${renderIcon('workflow', 'w-5 h-5 mr-2')}<span class="font-mono">${name}</span></h3></div>
                                    <div class="flex items-center gap-2">${config.isDurable ? `<span class="bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full">Durable</span>` : ''}${config.isInternal ? `<span class="bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full">Internal</span>` : ''}</div>
                                </div>
                                <div class="mt-4"><button class="text-sm bg-gray-200 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-300 workflow-details-btn" data-dev-address="${devAddress}" data-workflow-name="${name}">View Configuration</button></div>
                            </div>`).join('')}
                        </div>
                    </div>
                </div>`).join('');
            
            container.querySelectorAll('.workflow-details-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const { devAddress, workflowName } = e.currentTarget.dataset;
                    const workflowConfig = state.pipelines[devAddress]?.[workflowName];
                    if (workflowConfig) {
                        const content = `<pre class="bg-dark text-light p-4 rounded-md text-sm whitespace-pre-wrap"><code class="language-json">${syntaxHighlight(workflowConfig)}</code></pre>`;
                        showDetailsModal(`Workflow: ${workflowName}`, content);
                    }
                });
            });
            lucide.createIcons();
        };

        const processStepLogsForDisplay = (stepLogs) => {
            if (!stepLogs || stepLogs.length === 0) return [];
            const processed = [];
            let i = 0;
            while (i < stepLogs.length) {
                const currentStep = stepLogs[i];
                const stepKey = `${currentStep.service}/${currentStep.field || currentStep.path || currentStep.callWorkflow}`;
                
                let j = i + 1;
                let retryCount = 0;
                while (j < stepLogs.length) {
                    const nextStep = stepLogs[j];
                    const nextStepKey = `${nextStep.service}/${nextStep.field || nextStep.path || nextStep.callWorkflow}`;
                    if (nextStepKey === stepKey && nextStep.error) {
                        retryCount++;
                        j++;
                    } else {
                        break;
                    }
                }
                
                processed.push({
                    ...currentStep,
                    retryCount: retryCount,
                    originalIndex: i,
                    lastAttemptIndex: j - 1
                });
                
                i = j;
            }
            return processed;
        };

        const renderMonitoringWorkflows = () => {
            const container = document.getElementById('monitoring-workflows-content');
            if (!container) return;
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4">
                    <input type="text" id="monitoring-workflow-name" placeholder="Workflow or User Address" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-600 focus:border-blue-600 md:col-span-2">
                    <select id="monitoring-status-filter" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-600 focus:border-blue-600">
                        <option value="">All Statuses</option>
                        <option value="RUNNING">Running</option>
                        <option value="COMPLETED">Completed</option>
                        <option value="FAILED">Failed</option>
                    </select>
                    <input type="datetime-local" id="monitoring-start-date" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-600 focus:border-blue-600">
                    <button id="refresh-monitoring-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors flex items-center justify-center">
                        <i data-lucide="refresh-cw" class="w-5 h-5 mr-2"></i>Refresh
                    </button>
                </div>
                <div id="monitoring-workflows-container" class="bg-white border border-gray-200 p-2 sm:p-4 rounded-lg shadow-inner h-[600px] overflow-y-auto"></div>`;

            document.getElementById('refresh-monitoring-btn').addEventListener('click', fetchMonitoredWorkflows);
            ['monitoring-workflow-name', 'monitoring-status-filter', 'monitoring-start-date'].forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    state.monitoringFilters[id === 'monitoring-workflow-name' ? 'name' : (id === 'monitoring-status-filter' ? 'status' : 'startDate')] = e.target.value;
                    fetchMonitoredWorkflows();
                });
            });

            renderFilteredMonitoredWorkflows();
        };

        const renderFilteredMonitoredWorkflows = () => {
            const container = document.getElementById('monitoring-workflows-container');
            if (!container) return;

            const data = state.workflows.monitored;
            if (!data || data.length === 0) {
                container.innerHTML = `<div class="text-center p-12 text-gray-500"><div class="text-3xl mb-4">${renderIcon('bar-chart-3')}</div>No monitored workflows found for the selected criteria.</div>`;
                lucide.createIcons(); return;
            }
            container.innerHTML = data.map(instance => { 
                let statusColor, statusIcon; 
                switch (instance.status) { 
                    case 'RUNNING': statusColor = 'border-blue-500'; statusIcon = renderIcon('loader-2', 'w-5 h-5 text-blue-500 animate-spin'); break; 
                    case 'COMPLETED': statusColor = 'border-green-500'; statusIcon = renderIcon('check-circle-2', 'w-5 h-5 text-green-500'); break; 
                    case 'FAILED': statusColor = 'border-red-500'; statusIcon = renderIcon('x-circle', 'w-5 h-5 text-red-500'); break; 
                    default: statusColor = 'border-gray-300'; statusIcon = renderIcon('help-circle', 'w-5 h-5 text-gray-500'); 
                } 

                const processedLogs = processStepLogsForDisplay(instance.stepLogs);

                return `<div class="workflow-instance group bg-white border-l-4 ${statusColor} p-3 my-2 rounded-r-lg shadow-sm text-sm"><div class="flex justify-between items-center cursor-pointer" onclick="this.parentElement.classList.toggle('open')"><div class="flex items-center overflow-hidden">${statusIcon}<span class="ml-2 font-mono text-blue-600">${new Date(instance.createdAt).toLocaleString()}</span><span class="ml-3 font-mono text-gray-700 truncate">${instance.workflowName}</span></div><div class="flex items-center"><span class="font-mono text-xs text-gray-400 mr-4" title="Instance ID">${instance.id.substring(0, 8)}...</span><i data-lucide="chevron-down" class="w-5 h-5 group-chevron text-gray-400 transition-transform"></i></div></div><div class="collapsible-content"><div class="mt-3 pt-3 border-t border-gray-200 text-gray-800 space-y-3">${instance.status === 'FAILED' ? `<div class="font-mono text-red-500 p-2 bg-red-100 rounded"><strong>Failure:</strong> ${instance.failureReason}</div>` : ''}<div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><strong class="font-semibold">Last Updated:</strong> <span class="font-mono">${new Date(instance.updatedAt).toLocaleString()}</span></div><div><strong class="font-semibold">Current Step:</strong> <span class="font-mono">${instance.currentStep}</span></div></div><div><strong class="font-semibold">Step Logs (${instance.stepLogs?.length || 0}):</strong><div class="pl-4 mt-1 space-y-2">${(processedLogs || []).map((step) => {
                    const isRetry = step.retryCount > 0;
                    return `<div class="p-2 bg-gray-50 rounded-md border border-gray-200"><div class="flex justify-between items-center text-xs"><span class="font-mono font-semibold">${step.service}/${step.field || step.path || step.callWorkflow}</span><div class="flex items-center gap-2">${isRetry ? `<span class="text-xs font-semibold text-orange-600 bg-orange-100 px-2 py-0.5 rounded-full flex items-center gap-1">${renderIcon('repeat', 'w-3 h-3')} ${step.retryCount} ${step.retryCount > 1 ? 'retries' : 'retry'}</span>` : ''}<span class="text-gray-500">Step ${step.originalIndex}</span></div></div><div class="mt-2"><button class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded workflow-step-btn" data-instance-id="${instance.id}" data-step-index="${step.lastAttemptIndex}" data-type="request">Req</button><button class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded ml-1 workflow-step-btn" data-instance-id="${instance.id}" data-step-index="${step.lastAttemptIndex}" data-type="response">Res</button></div></div>`
                }).join('')}</div></div><div><button class="text-sm bg-gray-200 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-300 workflow-context-btn" data-instance-id="${instance.id}">View Final Context</button></div></div></div></div>`; 
            }).join('');
            document.querySelectorAll('.workflow-step-btn').forEach(btn => { btn.addEventListener('click', e => { const { instanceId, stepIndex, type } = e.currentTarget.dataset; const instance = state.workflows.monitored.find(inst => inst.id === instanceId); const step = instance?.stepLogs?.[stepIndex]; if (step) { const data = type === 'request' ? step.request : step.response; showDetailsModal(`Step ${stepIndex} ${type}`, `<pre class="bg-dark text-light p-4 rounded-md text-xs whitespace-pre-wrap"><code class="language-json">${syntaxHighlight(data)}</code></pre>`); } }); });
            document.querySelectorAll('.workflow-context-btn').forEach(btn => { btn.addEventListener('click', e => { const instanceId = e.currentTarget.dataset.instanceId; const instance = state.workflows.monitored.find(inst => inst.id === instanceId); if (instance) { showDetailsModal(`Final Context for ${instance.id.substring(0,8)}...`, `<pre class="bg-dark text-light p-4 rounded-md text-sm whitespace-pre-wrap"><code class="language-json">${syntaxHighlight(instance.context)}</code></pre>`); } }); });
            lucide.createIcons();
        };

        const renderWallet = () => {
            const container = document.getElementById('wallet-tab');
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                    <div class="sub-tabs flex border-b border-gray-200 mb-6 overflow-x-auto">
                        <button class="sub-tab flex-shrink-0 py-3 px-4 text-center font-semibold text-gray-500 hover:bg-gray-50 border-b-2 border-transparent transition" data-subtab="wallet-main"><i data-lucide="layout-grid" class="inline-block w-5 h-5 mr-2"></i>Overview</button>
                        <button class="sub-tab flex-shrink-0 py-3 px-4 text-center font-semibold text-gray-500 hover:bg-gray-50 border-b-2 border-transparent transition" data-subtab="wallet-staking"><i data-lucide="anchor" class="inline-block w-5 h-5 mr-2"></i>Staking</button>
                        <button class="sub-tab flex-shrink-0 py-3 px-4 text-center font-semibold text-gray-500 hover:bg-gray-50 border-b-2 border-transparent transition" data-subtab="wallet-allowances"><i data-lucide="user-check" class="inline-block w-5 h-5 mr-2"></i>Allowances</button>
                        <button class="sub-tab flex-shrink-0 py-3 px-4 text-center font-semibold text-gray-500 hover:bg-gray-50 border-b-2 border-transparent transition" data-subtab="wallet-tokens"><i data-lucide="coins" class="inline-block w-5 h-5 mr-2"></i>Tokens</button>
                        <button class="sub-tab flex-shrink-0 py-3 px-4 text-center font-semibold text-gray-500 hover:bg-gray-50 border-b-2 border-transparent transition" data-subtab="wallet-history"><i data-lucide="history" class="inline-block w-5 h-5 mr-2"></i>History</button>
                    </div>
                    <div class="sub-tab-content" id="wallet-main-content"></div>
                    <div class="sub-tab-content hidden" id="wallet-staking-content"></div>
                    <div class="sub-tab-content hidden" id="wallet-allowances-content"></div>
                    <div class="sub-tab-content hidden" id="wallet-tokens-content"></div>
                    <div class="sub-tab-content hidden" id="wallet-history-content"></div>
                </div>`;
            
            lucide.createIcons();

            container.querySelectorAll('.sub-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    container.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
                    container.querySelectorAll('.sub-tab-content').forEach(c => c.classList.add('hidden'));
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.subtab}-content`).classList.remove('hidden');
                });
            });

            renderWalletMain();
            renderWalletStaking();
            renderWalletAllowances();
            renderWalletTokens();
            renderWalletHistoryContainer();

            container.querySelector('.sub-tab').click();

            fetchWalletData();
            fetchWalletHistory(1);
        };
        
        const renderWalletMain = () => {
            const container = document.getElementById('wallet-main-content');
            const isAdmin = config.authLevel === 'admin';
             container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-xl shadow-md border">
                            <h3 class="text-lg font-bold text-dark mb-4 flex items-center"><i data-lucide="user-circle" class="w-6 h-6 mr-3 text-blue-600"></i> Owner Wallet</h3>
                            <div class="space-y-3 text-sm">
                                <div>
                                    <p class="font-medium text-gray-500">Address</p>
                                    <p class="font-mono text-gray-600 break-all">${config.identity.address}</p>
                                </div>
                                <div class="grid grid-cols-2 gap-4 pt-2">
                                    <div>
                                        <p class="font-medium text-gray-500">Spendable Balance</p>
                                        <p><span id="wallet-balance" class="font-mono text-2xl font-bold text-dark">...</span> <span class="text-gray-500">GCU</span></p>
                                    </div>
                                     <div>
                                        <p class="font-medium text-gray-500">Next Nonce</p>
                                        <p><span id="wallet-nonce" class="font-mono text-2xl font-bold text-dark">...</span></p>
                                    </div>
                                </div>
                            </div>
                             ${isAdmin ? `<button id="create-wallet-btn" class="mt-6 w-full bg-secondary text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 transition-colors flex items-center justify-center gap-2">${renderIcon('plus-circle', 'w-5 h-5')} Create New Wallet on Node</button>` : ''}
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border">
                         <h3 class="text-lg font-bold text-dark mb-4 flex items-center"><i data-lucide="send" class="w-6 h-6 mr-3 text-blue-600"></i> Transfer GCU</h3>
                         <form id="transfer-form" class="space-y-4">
                            <div><label for="to-address" class="text-sm font-medium">Recipient Address</label><input type="text" id="to-address" required placeholder="0x..." class="w-full mt-1 p-2 border rounded-md font-mono"></div>
                            <div><label for="amount" class="text-sm font-medium">Amount</label><input type="number" id="amount" step="any" required placeholder="0.0" class="w-full mt-1 p-2 border rounded-md"></div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 flex items-center justify-center gap-2">${renderIcon('send', 'w-5 h-5')}Send Transaction</button>
                        </form>
                    </div>
                </div>
            `;
            lucide.createIcons();
            if (isAdmin) {
                document.getElementById('create-wallet-btn').addEventListener('click', showWalletCreationModal);
            }
             setupTransactionForm('transfer-form', '/wallet/transfer');
        };

        const renderWalletStaking = () => {
            const container = document.getElementById('wallet-staking-content');
            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                     <div class="space-y-6">
                        <div class="bg-white p-6 rounded-xl shadow-md border">
                            <h3 class="text-lg font-bold text-dark mb-4 flex items-center"><i data-lucide="anchor" class="w-6 h-6 mr-3 text-blue-600"></i> Universal Staking</h3>
                             <div id="staking-info" class="space-y-4 text-sm"></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md border">
                            <h3 class="text-lg font-bold text-dark mb-4 flex items-center"><i data-lucide="arrow-down-to-line" class="w-6 h-6 mr-3 text-green-600"></i> Deposit / Withdraw Stake</h3>
                            <p class="text-sm text-gray-600 mb-4">Move funds between your spendable balance and your universal staking pool.</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <form id="stake-deposit-form" class="space-y-2">
                                    <label for="stake-deposit-amount" class="text-sm font-medium">Amount to Deposit</label>
                                    <input type="number" id="stake-deposit-amount" step="any" required class="w-full p-2 border rounded-md">
                                    <button type="submit" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600">${renderIcon('arrow-down', 'w-4 h-4 inline')} Deposit</button>
                                </form>
                                <form id="stake-withdrawal-form" class="space-y-2">
                                     <label for="stake-withdrawal-amount" class="text-sm font-medium">Amount to Withdraw</label>
                                    <input type="number" id="stake-withdrawal-amount" step="any" required class="w-full p-2 border rounded-md">
                                    <button type="submit" class="w-full bg-red-500 text-white font-bold py-2 px-4 rounded-md hover:bg-red-600">${renderIcon('arrow-up', 'w-4 h-4 inline')} Withdraw</button>
                                </form>
                            </div>
                        </div>
                     </div>
                     <div class="bg-white p-6 rounded-xl shadow-md border">
                        <h3 class="text-lg font-bold text-dark mb-4 flex items-center"><i data-lucide="link" class="w-6 h-6 mr-3 text-blue-600"></i> Assign Stake to Node</h3>
                        <p class="text-sm text-gray-600 mb-4">Lock a portion of your available stake to an operational node to meet its hardware requirements.</p>
                        <form id="stake-assign-form" class="space-y-4">
                            <div><label for="assign-node-id" class="text-sm font-medium">Node Peer ID</label><input type="text" id="assign-node-id" required class="w-full mt-1 p-2 border rounded-md font-mono"></div>
                            <div><label for="assign-amount" class="text-sm font-medium">Amount to Assign</label><input type="number" id="assign-amount" step="any" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <button type="submit" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600">${renderIcon('link', 'w-4 h-4 inline')} Assign Stake</button>
                        </form>
                    </div>
                </div>
            `;
            lucide.createIcons();
            setupTransactionForm('stake-deposit-form', '/staking/deposit');
            setupTransactionForm('stake-withdrawal-form', '/staking/withdraw');
            setupTransactionForm('stake-assign-form', '/staking/assign');

            document.getElementById('staking-info').addEventListener('click', async (e) => {
                const unassignBtn = e.target.closest('.unassign-btn');
                if (unassignBtn) {
                    const nodePeerId = unassignBtn.dataset.peerId;
                    if (confirm(`Are you sure you want to unassign stake from node ${nodePeerId.substring(0,12)}...? The node must be offline for this to succeed.`)) {
                        try {
                            const nonceData = await apiFetch(`/wallet/nonce?address=${config.identity.address}`, { authType: 'public' });
                            const result = await apiFetch('/staking/unassign', { authType: 'user', body: { nodePeerId, nonce: nonceData.nonce + 1 } });
                            if (result && result.transactionId) {
                                alert(`Stake unassignment successful! TxID: ${result.transactionId}. Funds are now unbonding.`);
                                setTimeout(() => {
                                    fetchWalletData();
                                    fetchWalletHistory(1);
                                }, 500);
                            } else { alert(`Stake unassignment failed: ${result.message || 'Check console for details.'}`); }
                        } catch (err) {
                            alert(`Error during stake unassignment: ${err.message}`);
                        }
                    }
                }
            });
        };

        const renderWalletAllowances = () => {
             const container = document.getElementById('wallet-allowances-content');
             container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-md border">
                        <h3 class="text-lg font-bold text-dark mb-4 flex items-center"><i data-lucide="user-plus" class="w-6 h-6 mr-3 text-blue-600"></i>Set/Update GCU Allowance</h3>
                        <p class="text-sm text-gray-600 mb-4">Grant another address (a "spender") permission to transfer a specific amount of your GCU on your behalf. This is required for automated pipeline payments.</p>
                        <form id="set-allowance-form" class="space-y-4">
                            <div><label for="spender-address" class="text-sm font-medium">Spender Address</label><input type="text" id="spender-address" required placeholder="0x..." class="w-full mt-1 p-2 border rounded-md font-mono"></div>
                            <div><label for="allowance-amount" class="text-sm font-medium">Amount</label><input type="number" id="allowance-amount" step="any" required placeholder="0.0" class="w-full mt-1 p-2 border rounded-md"></div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 flex items-center justify-center gap-2">${renderIcon('check-circle', 'w-5 h-5')}Set Allowance</button>
                        </form>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border">
                        <h3 class="text-lg font-bold text-dark mb-4 flex items-center"><i data-lucide="search" class="w-6 h-6 mr-3 text-blue-600"></i>Manage Existing GCU Allowance</h3>
                        <p class="text-sm text-gray-600 mb-4">Check the current allowance for a specific spender and remove it if necessary.</p>
                        <form id="check-allowance-form" class="space-y-4">
                            <div><label for="query-spender-address" class="text-sm font-medium">Spender Address</label><input type="text" id="query-spender-address" required placeholder="0x..." class="w-full mt-1 p-2 border rounded-md font-mono"></div>
                            <button type="submit" class="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-700 flex items-center justify-center gap-2">${renderIcon('search', 'w-5 h-5')}Check Allowance</button>
                        </form>
                        <div id="allowance-result-container" class="mt-4"></div>
                    </div>
                </div>`;
            lucide.createIcons();
            setupAllowanceForms();
        };

        const renderWalletTokens = () => {
            const container = document.getElementById('wallet-tokens-content');
            container.innerHTML = `
                <div class="space-y-6">
                    <!-- Top Section: Create and Select Token -->
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-md border">
                        <div id="token-selector-container" class="w-full md:w-2/3">
                            <!-- Token selector will be rendered here -->
                        </div>
                        <button id="create-token-btn" class="w-full md:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 flex items-center justify-center gap-2 flex-shrink-0">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i>Create New Token
                        </button>
                    </div>

                    <!-- Management Section -->
                    <div id="token-management-section"></div>
                </div>
            `;
            lucide.createIcons();
            
            document.getElementById('create-token-btn').addEventListener('click', showCreateTokenModal);
            
            fetchAndRenderOwnedTokens();
            renderTokenManagementArea();
        };

        const fetchAndRenderOwnedTokens = async (retries = 3, delay = 2000) => {
            if (!config.identity) return;
            
            try {
                console.log('Fetching owned tokens... (retry attempts remaining:', retries, ')');
                
                const result = await apiFetch(`/token/owned?owner=${config.identity.address}`, { 
                authType: 'user', 
                method: 'GET' 
                });
                
                // Update state with fetched tokens
                const newTokenList = result && result.tokens ? result.tokens : [];
                const previousCount = state.wallet.tokens.list.length;
                state.wallet.tokens.list = newTokenList;
                
                console.log('Owned tokens fetched:', newTokenList.length, 'tokens (previously:', previousCount, ')');
                
                // If the currently selected token is no longer in the list, deselect it
                if (state.wallet.tokens.selected && 
                    !state.wallet.tokens.list.some(t => t.token.address === state.wallet.tokens.selected.token.address)) {
                state.wallet.tokens.selected = null;
                state.wallet.tokens.selectedTokenInfo = null;
                // Re-render management area since selection changed
                renderTokenManagementArea();
                }
                
                // FIXED: Always re-render selector and list to show updated tokens
                renderTokenSelector();
                
                return true;
            } catch (err) {
                console.error('Failed to fetch owned tokens:', err);
                
                // FIXED: Retry logic for blockchain sync delays
                if (retries > 0) {
                console.log(`Retrying in ${delay}ms...`);
                await new Promise(resolve => setTimeout(resolve, delay));
                return await fetchAndRenderOwnedTokens(retries - 1, delay);
                }
                
                showNotification('error', `Failed to refresh token list: ${err.message}`);
                return false;
            }
        };

        const renderTokenSelector = () => {
            const container = document.getElementById('token-selector-container');
            if(!container) return;
            
            const filteredTokens = state.wallet.tokens.list.filter(t => 
                t.token.name.toLowerCase().includes(state.wallet.tokens.searchTerm.toLowerCase()) ||
                t.token.ticker.toLowerCase().includes(state.wallet.tokens.searchTerm.toLowerCase()) ||
                t.token.address.toLowerCase().includes(state.wallet.tokens.searchTerm.toLowerCase())
            );
            
            const selectedToken = state.wallet.tokens.selected;
            
            // Check if this is initial render
            const isInitialRender = !document.getElementById('token-selector-button');
            
            if (isInitialRender) {
                container.innerHTML = `
                    <label class="text-sm font-medium text-gray-700 block mb-1">Your Owned Tokens (Optional)</label>
                    <div class="relative">
                        <button id="token-selector-button" class="w-full bg-white border border-gray-300 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-default focus:outline-none focus:ring-1 focus:ring-blue-600 focus:border-blue-600 sm:text-sm">
                            ${selectedToken ? `
                                <span class="flex items-center">
                                    <span class="ml-3 block truncate font-semibold">${selectedToken.token.name} (${selectedToken.token.ticker})</span>
                                </span>
                            ` : `
                                <span class="ml-3 block truncate text-gray-500">${state.wallet.tokens.list.length > 0 ? 'Select a token to auto-fill forms...' : 'You do not own any tokens.'}</span>
                            `}
                            <span class="ml-3 absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                <i data-lucide="chevrons-up-down" class="h-5 w-5 text-gray-400"></i>
                            </span>
                        </button>
                        <div id="token-selector-dropdown" class="${state.wallet.tokens.selectorOpen ? 'block' : 'hidden'} absolute z-10 mt-1 w-full bg-white shadow-lg rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm" style="max-height: 200px">
                            <div class="p-2">
                                <input type="search" id="token-search-input" class="w-full p-2 border rounded-md" placeholder="Search your tokens..." value="${state.wallet.tokens.searchTerm}">
                            </div>
                            <div id="token-list-container"></div>
                        </div>
                    </div>
                `;
                
                lucide.createIcons();
                
                // Attach event listeners after initial render
                document.getElementById('token-selector-button').addEventListener('click', () => {
                    state.wallet.tokens.selectorOpen = !state.wallet.tokens.selectorOpen;
                    renderTokenSelector();
                });
                
                document.getElementById('token-search-input').addEventListener('input', (e) => {
                    state.wallet.tokens.searchTerm = e.target.value;
                    // Re-filter tokens based on new search term
                    const updatedFilteredTokens = state.wallet.tokens.list.filter(t => 
                        t.token.name.toLowerCase().includes(state.wallet.tokens.searchTerm.toLowerCase()) ||
                        t.token.ticker.toLowerCase().includes(state.wallet.tokens.searchTerm.toLowerCase()) ||
                        t.token.address.toLowerCase().includes(state.wallet.tokens.searchTerm.toLowerCase())
                    );
                    renderTokenList(updatedFilteredTokens); // Update list with filtered results
                });
            } else {
                // Update only the button text if selection changed
                const button = document.getElementById('token-selector-button');
                if (button) {
                    button.innerHTML = `
                        ${selectedToken ? `
                            <span class="flex items-center">
                                <span class="ml-3 block truncate font-semibold">${selectedToken.token.name} (${selectedToken.token.ticker})</span>
                            </span>
                        ` : `
                            <span class="ml-3 block truncate text-gray-500">${state.wallet.tokens.list.length > 0 ? 'Select a token to auto-fill forms...' : 'You do not own any tokens.'}</span>
                        `}
                        <span class="ml-3 absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                            <i data-lucide="chevrons-up-down" class="h-5 w-5 text-gray-400"></i>
                        </span>
                    `;
                }
                
                // Update dropdown visibility
                const dropdown = document.getElementById('token-selector-dropdown');
                if (dropdown) {
                    dropdown.className = `${state.wallet.tokens.selectorOpen ? 'block' : 'hidden'} absolute z-10 mt-1 w-full bg-white shadow-lg rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm`;
                }
                
                // Update search input value if it exists
                const searchInput = document.getElementById('token-search-input');
                if (searchInput && searchInput.value !== state.wallet.tokens.searchTerm) {
                    searchInput.value = state.wallet.tokens.searchTerm;
                }
                
                lucide.createIcons();
            }
            
            // Always update the token list with filtered results
            renderTokenList(filteredTokens);
        };

        // Helper function to only update the token list
        const renderTokenList = (filteredTokens) => {
            const listContainer = document.getElementById('token-list-container');
            if (!listContainer) return;
            
            listContainer.innerHTML = filteredTokens.length > 0 ? 
                filteredTokens.map(t => {
                    const displayBalance = (t.balance / Math.pow(10, t.token.decimals)).toFixed(t.token.decimals);
                    return `
                        <div class="token-selector-item cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-blue-100" data-address="${t.token.address}">
                            <div class="flex justify-between items-center">
                                <span class="font-normal truncate">${t.token.name} (${t.token.ticker})</span>
                                <span class="text-xs text-gray-500 font-mono">${displayBalance}</span>
                            </div>
                            <p class="text-xs text-gray-400 font-mono truncate">${t.token.address}</p>
                        </div>
                    `;
                }).join('') 
                : `<div class="text-center text-gray-500 py-2">No owned tokens match your search.</div>`;
            
            // Attach click handlers to token items after rendering
            document.querySelectorAll('.token-selector-item').forEach(item => {
                item.addEventListener('click', async (e) => {
                    const address = e.currentTarget.dataset.address;
                    await handleTokenSelect(address);
                });
            });
        };

        const handleTokenSelect = async (tokenAddress) => {
            const selected = state.wallet.tokens.list.find(t => t.token.address === tokenAddress);
            if(selected) {
                state.wallet.tokens.selected = selected;
                state.wallet.tokens.selectorOpen = false;
                renderTokenSelector();
                
                // Fetch detailed token info
                const tokenInfo = await apiFetch(`/token/info?address=${tokenAddress}`, { authType: 'public' });
                state.wallet.tokens.selectedTokenInfo = tokenInfo;
                
                renderTokenManagementArea();
            }
        };

        const renderTokenDetails = (tokenInfo) => {
            if (!tokenInfo) {
                return `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md" role="alert">
                          <p>Select a token from the dropdown to view its full details.</p>
                      </div>`;
            }

            const decimals = tokenInfo.decimals || 0;
            const totalSupply = (tokenInfo.totalSupply / Math.pow(10, decimals)).toFixed(decimals);

            return `
                <div class="bg-white p-6 rounded-xl shadow-md border space-y-4">
                    <h3 class="text-lg font-bold text-dark mb-2 flex items-center">${renderIcon('file-text', 'w-6 h-6 mr-3')}Token Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3 text-sm">
                        <div><strong class="text-gray-600">Name:</strong><span class="ml-2 font-semibold">${tokenInfo.name}</span></div>
                        <div><strong class="text-gray-600">Ticker:</strong><span class="ml-2 font-semibold">${tokenInfo.ticker}</span></div>
                        <div><strong class="text-gray-600">Decimals:</strong><span class="ml-2 font-semibold">${tokenInfo.decimals}</span></div>
                        <div><strong class="text-gray-600">Total Supply:</strong><span class="ml-2 font-semibold">${totalSupply}</span></div>
                        <div><strong class="text-gray-600">Type:</strong><span class="ml-2 font-semibold">${tokenInfo.tokenType}</span></div>
                        <div><strong class="text-gray-600">Created:</strong><span class="ml-2 font-semibold">${new Date(tokenInfo.createdAt).toLocaleString()}</span></div>
                        <div class="md:col-span-2"><strong class="text-gray-600">Address:</strong><span class="ml-2 font-mono text-xs break-all">${tokenInfo.address}</span></div>
                        <div class="md:col-span-2"><strong class="text-gray-600">Creator:</strong><span class="ml-2 font-mono text-xs break-all">${tokenInfo.creator}</span></div>
                    </div>
                     <div class="pt-4 border-t">
                        <h4 class="font-semibold mb-2">Configuration</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                           <div class="bg-gray-50 p-3 rounded-lg border">
                                <h5 class="font-bold mb-2">Minting</h5>
                                <p><strong>Enabled:</strong> ${tokenInfo.mintConfig?.enabled ? 'Yes' : 'No'}</p>
                                <p><strong>Manual Mint:</strong> ${tokenInfo.mintConfig?.manualMint ? 'Yes' : 'No'}</p>
                                <p><strong>Auto Rate:</strong> ${tokenInfo.mintConfig?.mintRatePerTx || 0}%</p>
                           </div>
                           <div class="bg-gray-50 p-3 rounded-lg border">
                                <h5 class="font-bold mb-2">Burning</h5>
                                <p><strong>Enabled:</strong> ${tokenInfo.burnConfig?.enabled ? 'Yes' : 'No'}</p>
                                <p><strong>Manual Burn:</strong> ${tokenInfo.burnConfig?.manualBurn ? 'Yes' : 'No'}</p>
                                <p><strong>Auto Rate:</strong> ${tokenInfo.burnConfig?.burnRatePerTx || 0}%</p>
                           </div>
                        </div>
                    </div>
                    <div class="pt-4 border-t">
                         <h4 class="font-semibold mb-2">Metadata</h4>
                         <pre class="bg-dark text-light p-4 rounded-md text-xs whitespace-pre-wrap max-h-48 overflow-auto"><code class="language-json">${syntaxHighlight(tokenInfo.metadata)}</code></pre>
                    </div>
                </div>
            `;
        }

        const renderTokenManagementArea = () => {
            const container = document.getElementById('token-management-section');
            if(!container) return;

            const selectedToken = state.wallet.tokens.selected;
            const tokenInfo = state.wallet.tokens.selectedTokenInfo;
            const isCreator = selectedToken && tokenInfo ? tokenInfo.creator === config.identity.address : false;
            const isLocked = tokenInfo ? tokenInfo.configLocked : false;  // NEW: Check lock status
            const decimals = selectedToken ? selectedToken.token.decimals : 6;

            container.innerHTML = `
                <div class="flex flex-col md:flex-row gap-8">
                    <!-- Left Side Nav -->
                    <div class="w-full md:w-1/4">
                        <div class="bg-white p-3 rounded-xl shadow-md border space-y-2">
                            ${selectedToken ? `
                                <div class="p-3 border-b mb-2">
                                    <h3 class="font-bold text-lg truncate">${selectedToken.token.name}</h3>
                                    <p class="text-sm text-gray-500">${selectedToken.token.ticker}</p>
                                    <p class="text-lg font-semibold mt-1">${(selectedToken.balance / Math.pow(10, decimals)).toFixed(decimals)}</p>
                                    ${isLocked ? `<span class="inline-block mt-2 px-2 py-1 bg-gray-200 text-gray-700 text-xs rounded-full"><i data-lucide="lock" class="w-3 h-3 inline mr-1"></i>Config Locked</span>` : ''}
                                </div>
                            ` : `
                                <div class="p-3 border-b mb-2">
                                    <h3 class="font-bold text-lg">No Token Selected</h3>
                                    <p class="text-sm text-gray-500">Select above or enter manually.</p>
                                </div>
                            `}
                                                   
                            <a href="#" class="token-nav-link flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition-colors" data-target="token-details-content">
                                <i data-lucide="file-text" class="w-5 h-5 text-gray-500"></i> 
                                <span class="font-semibold">Details</span>
                            </a>
                            
                            <div class="border-t my-2"></div>
                            
                            <a href="#" class="token-nav-link active flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition-colors" data-target="token-transaction-content">
                                <i data-lucide="arrow-right-left" class="w-5 h-5 text-gray-500"></i> 
                                <span class="font-semibold">Transactions</span>
                            </a>
                            <a href="#" class="token-nav-link flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition-colors" data-target="token-manage-content">
                                <i data-lucide="settings" class="w-5 h-5 text-gray-500"></i> 
                                <span class="font-semibold">Manage</span>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Right Content Area -->
                    <div class="w-full md:w-3/4">
                        <!-- Details Panel -->
                        <div id="token-details-content" class="token-content-panel hidden">
                        ${renderTokenDetails(tokenInfo)}
                        </div>
                        
                        <!-- Transaction Panel -->
                        <div id="token-transaction-content" class="token-content-panel space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-md border">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-bold text-dark flex items-center">
                                        <i data-lucide="send" class="w-6 h-6 mr-3"></i>Token Operations
                                    </h3>
                                    <div class="flex gap-2">
                                        <button class="operation-selector active px-4 py-2 rounded-md border-2 border-blue-500 bg-blue-50 text-blue-700 font-semibold" data-operation="transfer">Transfer</button>
                                        <button class="operation-selector px-4 py-2 rounded-md border-2 border-gray-300 text-gray-700 font-semibold hover:border-gray-400" data-operation="allowance">Allowance</button>
                                    </div>
                                </div>
                                
                                <!-- Transfer Form -->
                                <form id="token-transfer-form" class="operation-form space-y-3 text-sm">
                                    <div><label class="text-xs font-medium text-gray-600">Token Address</label><input name="tokenAddress" required placeholder="Token Address" class="w-full p-2 border rounded-md font-mono text-xs"></div>
                                    <div><label class="text-xs font-medium text-gray-600">Recipient</label><input name="to" required placeholder="Recipient Address" class="w-full p-2 border rounded-md font-mono"></div>
                                    <div><label class="text-xs font-medium text-gray-600">Amount</label><input name="amount" type="number" step="${1/Math.pow(10, decimals)}" required placeholder="Amount" class="w-full p-2 border rounded-md"></div>
                                    <button type="submit" class="w-full bg-blue-500 text-white font-bold py-2 rounded-md hover:bg-blue-600"><i data-lucide="send" class="w-4 h-4 inline"></i> Transfer</button>
                                </form>
                                
                                <!-- Allowance Form -->
                                <form id="token-allowance-set-form" class="operation-form hidden space-y-3 text-sm">
                                    <div><label class="text-xs font-medium text-gray-600">Token Address</label><input name="tokenAddress" required placeholder="Token Address" class="w-full p-2 border rounded-md font-mono text-xs"></div>
                                    <div><label class="text-xs font-medium text-gray-600">Spender</label><input name="spender" required placeholder="Spender Address" class="w-full p-2 border rounded-md font-mono"></div>
                                    <div><label class="text-xs font-medium text-gray-600">Amount</label><input name="amount" type="number" step="${1/Math.pow(10, decimals)}" required placeholder="Amount" class="w-full p-2 border rounded-md"></div>
                                    <div class="flex gap-2">
                                        <button type="submit" class="w-full bg-green-500 text-white font-bold py-2 rounded-md hover:bg-green-600"><i data-lucide="check" class="w-4 h-4 inline"></i> Set</button>
                                        <button type="button" id="token-allowance-delete-btn" class="w-full bg-red-500 text-white font-bold py-2 rounded-md hover:bg-red-600"><i data-lucide="x" class="w-4 h-4 inline"></i> Delete</button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Check Info Section -->
                            <div class="bg-white p-6 rounded-xl shadow-md border">
                                <h3 class="text-lg font-bold text-dark mb-4 flex items-center"><i data-lucide="search" class="w-6 h-6 mr-3"></i>Check Info</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                    <div>
                                        <h4 class="font-semibold mb-2">Balance</h4>
                                        <div id="token-balance-container" class="text-center text-xl font-bold p-4 bg-gray-50 rounded-lg">
                                            <span class="text-sm text-gray-500">Enter Recipient Address above to check balance</span>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold mb-2">Allowance</h4>
                                        <div id="token-allowance-container" class="text-center text-xl font-bold p-4 bg-gray-50 rounded-lg">
                                            <span class="text-sm text-gray-500">Enter Token Address and Spender above to check allowance</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Manage Panel -->
                        <div id="token-manage-content" class="token-content-panel hidden space-y-6">
                            ${!selectedToken || !isCreator ? `
                            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md">
                                <p class="font-bold">Creator Only Actions</p>
                                <p>Select a token you created to access management functions.</p>
                            </div>` : `
                            ${isLocked ? `
                            <div class="bg-gray-100 border-l-4 border-gray-500 text-gray-700 p-4 rounded-md">
                                <p class="font-bold flex items-center"><i data-lucide="lock" class="w-5 h-5 mr-2"></i>Configuration Locked</p>
                                <p class="text-sm">This token's configuration has been permanently locked and cannot be modified.</p>
                            </div>` : ''}
                            
                            <!-- Manual Mint & Burn Card -->
                            <div class="bg-white p-6 rounded-xl shadow-md border">
                                <h3 class="text-lg font-bold text-dark mb-4 flex items-center"><i data-lucide="flame" class="w-6 h-6 mr-3"></i>Manual Mint & Burn</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                    <form id="token-mint-form" class="space-y-3 text-sm">
                                        <h4 class="font-semibold">Mint Tokens</h4>
                                        <input name="tokenAddress" type="hidden" value="${selectedToken.token.address}">
                                        <input name="to" required placeholder="Recipient Address" class="w-full p-2 border rounded-md font-mono" ${!tokenInfo.mintConfig.manualMint ? 'disabled' : ''}>
                                        <input name="amount" type="number" step="${1/Math.pow(10, decimals)}" required placeholder="Amount" class="w-full p-2 border rounded-md" ${!tokenInfo.mintConfig.manualMint ? 'disabled' : ''}>
                                        <button type="submit" class="w-full bg-green-500 text-white font-bold py-2 rounded-md hover:bg-green-600" ${!tokenInfo.mintConfig.manualMint ? 'disabled' : ''}><i data-lucide="plus" class="w-4 h-4 inline"></i> Mint</button>
                                        ${!tokenInfo.mintConfig.manualMint ? '<p class="text-xs text-gray-500">Manual minting is not enabled for this token</p>' : ''}
                                    </form>
                                    <form id="token-burn-form" class="space-y-3 text-sm">
                                        <h4 class="font-semibold">Burn Tokens</h4>
                                        <input name="tokenAddress" type="hidden" value="${selectedToken.token.address}">
                                        <input name="amount" type="number" step="${1/Math.pow(10, decimals)}" required placeholder="Amount" class="w-full p-2 border rounded-md" ${!tokenInfo.burnConfig.manualBurn ? 'disabled' : ''}>
                                        <button type="submit" class="w-full bg-red-500 text-white font-bold py-2 rounded-md hover:bg-red-600" ${!tokenInfo.burnConfig.manualBurn ? 'disabled' : ''}><i data-lucide="trash-2" class="w-4 h-4 inline"></i> Burn</button>
                                        ${!tokenInfo.burnConfig.manualBurn ? '<p class="text-xs text-gray-500">Manual burning is not enabled for this token</p>' : ''}
                                    </form>
                                </div>
                            </div>
                            
                            <!-- Configuration Card -->
                            <div class="bg-white p-6 rounded-xl shadow-md border">
                                <h3 class="text-lg font-bold text-dark mb-4 flex items-center"><i data-lucide="sliders-horizontal" class="w-6 h-6 mr-3"></i>Configuration ${isLocked ? '<span class="ml-2 text-sm font-normal text-gray-500">(Locked)</span>' : ''}</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-b pb-4 mb-4">
                                    <form id="token-mint-config-form" class="space-y-3 text-sm">
                                        <h4 class="font-semibold">Minting Config</h4>
                                        <input name="tokenAddress" type="hidden" value="${selectedToken.token.address}">
                                        <label class="flex items-center gap-2"><input type="checkbox" name="enabled" ${tokenInfo.mintConfig?.enabled ? 'checked' : ''} ${isLocked ? 'disabled' : ''}> Enable</label>
                                        <label class="flex items-center gap-2"><input type="checkbox" name="manualMint" ${tokenInfo.mintConfig?.manualMint ? 'checked' : ''} ${isLocked ? 'disabled' : ''}> Manual Mint</label>
                                        <div><label class="text-xs">Mint Rate/Tx (%)</label><input name="rate" type="number" step="0.01" min="0" max="100" value="${tokenInfo.mintConfig?.mintRatePerTx || 0}" class="w-full p-2 border rounded-md" ${isLocked ? 'disabled' : ''}></div>
                                        <button type="submit" class="w-full bg-blue-500 text-white font-bold py-2 rounded-md hover:bg-blue-600" ${isLocked ? 'disabled' : ''}>Update</button>
                                    </form>
                                    <form id="token-burn-config-form" class="space-y-3 text-sm">
                                        <h4 class="font-semibold">Burning Config</h4>
                                        <input name="tokenAddress" type="hidden" value="${selectedToken.token.address}">
                                        <label class="flex items-center gap-2"><input type="checkbox" name="enabled" ${tokenInfo.burnConfig?.enabled ? 'checked' : ''} ${isLocked ? 'disabled' : ''}> Enable</label>
                                        <label class="flex items-center gap-2"><input type="checkbox" name="manualBurn" ${tokenInfo.burnConfig?.manualBurn ? 'checked' : ''} ${isLocked ? 'disabled' : ''}> Manual Burn</label>
                                        <div><label class="text-xs">Burn Rate/Tx (%)</label><input name="rate" type="number" step="0.01" min="0" max="100" value="${tokenInfo.burnConfig?.burnRatePerTx || 0}" class="w-full p-2 border rounded-md" ${isLocked ? 'disabled' : ''}></div>
                                        <button type="submit" class="w-full bg-blue-500 text-white font-bold py-2 rounded-md hover:bg-blue-600" ${isLocked ? 'disabled' : ''}>Update</button>
                                    </form>
                                </div>
                                <form id="token-config-lock-form" class="space-y-3 text-sm">
                                    <input name="tokenAddress" type="hidden" value="${selectedToken.token.address}">
                                    <p class="text-xs text-gray-600">Permanently lock configuration. Cannot be undone.</p>
                                    <button type="submit" class="w-full bg-gray-700 text-white font-bold py-2 rounded-md hover:bg-gray-800" ${isLocked ? 'disabled' : ''}><i data-lucide="lock" class="w-4 h-4 inline"></i> ${isLocked ? 'Already Locked' : 'Lock Config'}</button>
                                </form>
                            </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
            
            lucide.createIcons();
            setupTokenForms();
            setupBalanceCheck();
            
            // Rest of the function remains the same...
            document.querySelectorAll('.token-nav-link').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    document.querySelectorAll('.token-nav-link').forEach(l => l.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    document.querySelectorAll('.token-content-panel').forEach(p => p.classList.add('hidden'));
                    document.getElementById(e.currentTarget.dataset.target).classList.remove('hidden');
                });
            });
            
            document.querySelectorAll('.operation-selector').forEach(btn => {
                btn.addEventListener('click', e => {
                    document.querySelectorAll('.operation-selector').forEach(b => {
                        b.classList.remove('active', 'border-blue-500', 'bg-blue-50', 'text-blue-700');
                        b.classList.add('border-gray-300', 'text-gray-700');
                    });
                    e.currentTarget.classList.add('active', 'border-blue-500', 'bg-blue-50', 'text-blue-700');
                    e.currentTarget.classList.remove('border-gray-300', 'text-gray-700');
                    
                    const operation = e.currentTarget.dataset.operation;
                    document.querySelectorAll('.operation-form').forEach(f => f.classList.add('hidden'));
                    if (operation === 'transfer') {
                        document.getElementById('token-transfer-form').classList.remove('hidden');
                    } else {
                        document.getElementById('token-allowance-set-form').classList.remove('hidden');
                    }
                });
            });
            
            if (selectedToken) {
                document.querySelectorAll('#token-management-section input[name="tokenAddress"]').forEach(input => {
                    input.value = selectedToken.token.address;
                });
            }
        };

        const setupTokenForms = () => {
            // Auth required POST forms
            setupTokenTransactionForm('token-transfer-form', '/token/transfer');
            setupTokenTransactionForm('token-allowance-set-form', '/token/allowance/set');
            setupTokenTransactionForm('token-mint-form', '/token/mint');
            setupTokenTransactionForm('token-burn-form', '/token/burn');
            setupTokenTransactionForm('token-config-lock-form', '/token/config/lock');
            setupTokenTransactionForm('token-mint-config-form', '/token/mintable/set');
            setupTokenTransactionForm('token-burn-config-form', '/token/burnable/set');

            // Special handling for delete allowance
            const deleteBtn = document.getElementById('token-allowance-delete-btn');
             if(deleteBtn) {
                 deleteBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const form = document.getElementById('token-allowance-set-form');
                    const tokenAddress = form.querySelector('input[name="tokenAddress"]').value;
                    const spender = form.querySelector('input[name="spender"]').value;
                    if (!tokenAddress || !spender) { 
                        showNotification('warning', 'Token Address and Spender are required to delete allowance.'); 
                        return; 
                    }
                    
                    if (confirm(`Are you sure you want to delete the allowance for ${spender} on token ${tokenAddress.substring(0,10)}...?`)) {
                        try {
                            const nonceData = await apiFetch(`/wallet/nonce?address=${config.identity.address}`, { authType: 'public' });
                            const result = await apiFetch('/token/allowance/delete', {
                                authType: 'user', 
                                body: { tokenAddress, spender, nonce: nonceData.nonce + 1 }
                            });
                            if (result && result.transactionId) {
                                showNotification('success', `Allowance deleted! TxID: ${result.transactionId}`);
                                setTimeout(() => {
                                    if(state.wallet.tokens.selected) {
                                        handleTokenSelect(state.wallet.tokens.selected.token.address);
                                    }
                                }, 1000);
                            } else {
                                showNotification('error', result.message || 'Failed to delete allowance.');
                            }
                        } catch (err) {
                            showNotification('error', `Error: ${err.message}`);
                        }
                    }
                });
             }
            
            // Setup live allowance checking on spender input
            setupAllowanceCheck();
        };
        
        const setupAllowanceCheck = () => {
            const spenderInput = document.querySelector('#token-allowance-set-form input[name="spender"]');
            if (!spenderInput) return;
            
            let debounceTimer;
            spenderInput.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                const spender = e.target.value;
                
                if (!spender || spender.length < 10) {
                    const allowanceContainer = document.getElementById('token-allowance-container');
                    if (allowanceContainer) {
                        allowanceContainer.innerHTML = '<span class="text-sm text-gray-500">Enter spender address</span>';
                    }
                    return;
                }
                
                debounceTimer = setTimeout(async () => {
                    if (!state.wallet.tokens.selected || !config.identity) return;
                    
                    const tokenAddress = state.wallet.tokens.selected.token.address;
                    const tokenInfo = state.wallet.tokens.selectedTokenInfo;
                    
                    try {
                        const result = await apiFetch(
                            `/token/allowance?tokenAddress=${tokenAddress}&owner=${config.identity.address}&spender=${spender}`, 
                            {authType: 'public'}
                        );
                        
                        const allowanceContainer = document.getElementById('token-allowance-container');
                        if (allowanceContainer && result && typeof result.allowance !== 'undefined' && tokenInfo) {
                            const decimals = tokenInfo.decimals || 0;
                            const ticker = tokenInfo.ticker || 'Tokens';
                            const displayAllowance = result.allowance.toFixed(decimals);
                            allowanceContainer.innerHTML = `${displayAllowance} <span class="text-sm text-gray-500">${ticker}</span>`;
                        }
                    } catch (err) {
                        console.error('Failed to fetch allowance:', err);
                    }
                }, 500);
            });
        };

        // Add this function after setupAllowanceCheck function
        const setupBalanceCheck = () => {
            const recipientInput = document.querySelector('#token-transfer-form input[name="to"]');
            if (!recipientInput) return;
            
            let debounceTimer;
            recipientInput.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                const recipient = e.target.value;
                
                // Clear the balance display if input is invalid
                if (!recipient || recipient.length < 10) {
                    const balanceContainer = document.getElementById('token-balance-container');
                    if (balanceContainer) {
                        balanceContainer.innerHTML = `<span class="text-sm text-gray-500">Enter Recipient Address</span>`;
                    }
                    return;
                }
                
                // Debounced balance check
                debounceTimer = setTimeout(async () => {
                    const tokenAddressInput = document.querySelector('#token-transfer-form input[name="tokenAddress"]');
                    if (!tokenAddressInput) return;
                    
                    const tokenAddress = tokenAddressInput.value;
                    if (!tokenAddress || tokenAddress.length < 10) {
                        const balanceContainer = document.getElementById('token-balance-container');
                        if (balanceContainer) {
                            balanceContainer.innerHTML = `<span class="text-sm text-gray-500">Enter Token Address to check balance</span>`;
                        }
                        return;
                    }
                    
                    try {
                        const result = await apiFetch(
                            `/token/balance?tokenAddress=${tokenAddress}&owner=${recipient}`,
                            { authType: 'public' }
                        );
                        
                        const balanceContainer = document.getElementById('token-balance-container');
                        if (balanceContainer && result && typeof result.balance !== 'undefined') {
                            // Get token info for decimals and ticker
                            const tokenInfo = state.wallet.tokens.selectedTokenInfo;
                            const decimals = tokenInfo?.decimals || 0;
                            const ticker = tokenInfo?.ticker || 'Tokens';
                            const displayBalance = result.balance.toFixed(decimals);
                            balanceContainer.innerHTML = `${displayBalance} <span class="text-sm text-gray-500">${ticker}</span>`;
                        }
                    } catch (err) {
                        console.error('Failed to fetch recipient balance:', err);
                    }
                }, 500);
            });
        };
        
        // Helper to refresh token display after operations
        const refreshTokenDisplay = async () => {
            if (!state.wallet.tokens.selected || !config.identity) return;
            
            const tokenAddress = state.wallet.tokens.selected.token.address;
            
            try {
                // Refetch token info for updated supply
                const tokenInfo = await apiFetch(`/token/info?address=${tokenAddress}`, {authType: 'public'});
                if (tokenInfo && !tokenInfo.error) {
                    state.wallet.tokens.selectedTokenInfo = tokenInfo;
                }
                
                // FIXED: Refetch balance
                const balanceResult = await apiFetch(
                    `/token/balance?tokenAddress=${tokenAddress}&owner=${config.identity.address}`, 
                    {authType: 'public'}
                );
                
                // Update balance in the check info section
                const balanceContainer = document.getElementById('token-balance-container');
                if (balanceContainer && balanceResult && typeof balanceResult.balance !== 'undefined') {
                    const decimals = tokenInfo?.decimals || 0;
                    const ticker = tokenInfo?.ticker || 'Tokens';
                    const displayBalance = balanceResult.balance.toFixed(decimals);
                    balanceContainer.innerHTML = `${displayBalance} <span class="text-sm text-gray-500">${ticker}</span>`;
                }
                
                // Update the token list to reflect new balance
                const tokenInList = state.wallet.tokens.list.find(t => t.token.address === tokenAddress);
                if (tokenInList && balanceResult && typeof balanceResult.balance !== 'undefined') {
                    tokenInList.balance = balanceResult.balance;
                }
                
                // Re-render the management area to show updated info
                renderTokenManagementArea();
                
                console.log('Token display refreshed successfully');
            } catch (err) {
                console.error('Failed to refresh token display:', err);
            }
        }       
        
        const setupTokenTransactionForm = (formId, endpoint, isModal = false) => {
            const form = document.getElementById(formId);
            if(!form) return;

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                let payload = {};
                let originalText;

                // Build payload based on endpoint
                if (endpoint === "/token/create") {
                const tokenMetadata = {};
                ['name', 'ticker', 'tokenType', 'metadata'].forEach(key => {
                    if (formData.has(key)) tokenMetadata[key] = formData.get(key);
                });
                ['decimals', 'initialSupply'].forEach(key => {
                    if (formData.has(key)) {
                    const val = parseFloat(formData.get(key));
                    if (!isNaN(val)) tokenMetadata[key] = val;
                    }
                });
                tokenMetadata.mintConfig = {
                    enabled: formData.get('mintConfigEnabled') === 'on',
                    manualMint: formData.get('mintConfigManualMint') === 'on'
                };
                tokenMetadata.burnConfig = {
                    enabled: formData.get('burnConfigEnabled') === 'on',
                    manualBurn: formData.get('burnConfigManualBurn') === 'on'
                };
                payload = { tokenMetadata };
                } else if (endpoint === "/token/mintable/set" || endpoint === "/token/burnable/set") {
                payload = {
                    tokenAddress: formData.get('tokenAddress'),
                    enabled: formData.get('enabled') === 'on',
                    rate: parseFloat(formData.get('rate') || 0)
                };
                if (endpoint === "/token/mintable/set") {
                    payload.manualMint = formData.get('manualMint') === 'on';
                } else {
                    payload.manualBurn = formData.get('manualBurn') === 'on';
                }
                } else {
                ['to', 'spender', 'tokenAddress'].forEach(key => {
                    if (formData.has(key)) payload[key] = formData.get(key);
                });
                ['amount'].forEach(key => {
                    if (formData.has(key)) {
                    const val = parseFloat(formData.get(key));
                    if (!isNaN(val)) payload[key] = val;
                    }
                });
                }

                try {
                const submitButton = form.querySelector('button[type=submit]');
                if (!submitButton) {
                    console.error('No submit button found in form', formId);
                    return;
                }

                originalText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.classList.add('opacity-50', 'cursor-not-allowed');
                submitButton.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-5 h-5 mx-auto"></i>`;
                lucide.createIcons();

                const nonceData = await apiFetch(`/wallet/nonce?address=${config.identity.address}`, { authType: 'public' });
                payload.nonce = nonceData.nonce + 1;

                console.log('Submitting transaction', endpoint, payload);
                const result = await apiFetch(endpoint, { authType: 'user', body: payload });
                console.log('Transaction result:', result);

                // Re-enable button
                submitButton.disabled = false;
                submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                submitButton.innerHTML = originalText;
                lucide.createIcons();

                // FIXED: Better success detection for token creation
                const isSuccess = result && 
                                !result.error && 
                                (result.id || result.transactionId || result.type === 'TOKEN_CREATE' || 
                                    (result.tokenMetadata && result.from) || 
                                    result.success === true);

                if (isSuccess) {
                    // Show success notification
                    const successMsg = result.message || 
                                    (result.tokenMetadata ? `Token "${result.tokenMetadata.name}" (${result.tokenMetadata.ticker}) created successfully! TX: ${result.id || 'pending'}` : 
                                    `Transaction successful! TxID: ${result.transactionId || result.id || 'pending'}`);
                    showNotification('success', successMsg);

                    // Reset form if not a modal and not a config update
                    if (!isModal && !endpoint.includes('config') && !endpoint.includes('mintable') && !endpoint.includes('burnable')) {
                    form.reset();
                    }

                    // Close modal if this is a modal form
                    if (isModal) {
                    hideCreateTokenModal();
                    }

                    // FIXED: More aggressive refresh strategy for token creation
                    console.log('Starting post-transaction refresh...');
                    
                    // CRITICAL: For token creation, use longer delay and force multiple refreshes
                    if(endpoint === "/token/create") {
                    // First refresh attempt after 2 seconds
                    setTimeout(async () => {
                        console.log('First refresh attempt...');
                        const success = await fetchAndRenderOwnedTokens(3, 2000); // 3 retries with 2s delay
                        
                        if (success) {
                        // Try to auto-select the newly created token
                        if (result.tokenMetadata) {
                            const newlyCreatedToken = state.wallet.tokens.list.find(
                            t => t.token.ticker === result.tokenMetadata.ticker && 
                                t.token.name === result.tokenMetadata.name
                            );
                            
                            if (newlyCreatedToken) {
                            console.log('Auto-selecting newly created token:', newlyCreatedToken.token.address);
                            await handleTokenSelect(newlyCreatedToken.token.address);
                            } else {
                            console.warn('Newly created token not found in list yet, will retry...');
                            // Second attempt after another 3 seconds
                            setTimeout(async () => {
                                console.log('Second refresh attempt...');
                                await fetchAndRenderOwnedTokens(2, 2000);
                                
                                const retryToken = state.wallet.tokens.list.find(
                                t => t.token.ticker === result.tokenMetadata.ticker && 
                                    t.token.name === result.tokenMetadata.name
                                );
                                
                                if (retryToken) {
                                console.log('Found token on retry, selecting:', retryToken.token.address);
                                await handleTokenSelect(retryToken.token.address);
                                }
                            }, 3000);
                            }
                        }
                        }
                        
                        // Always refresh wallet data
                        await fetchWalletData();
                        await fetchWalletHistory(1);
                    }, 2000);
                    } else {
                    // For other token operations, standard refresh
                    setTimeout(async () => {
                        await fetchWalletData();
                        await fetchWalletHistory(1);

                        if(endpoint.includes('config') || endpoint.includes('mintable') || endpoint.includes('burnable') || 
                        endpoint.includes('/token/mint') || endpoint.includes('/token/burn') || 
                        endpoint.includes('/token/transfer') || endpoint.includes('/token/allowance')) {
                        
                        await fetchAndRenderOwnedTokens();

                        // Refresh the currently selected token's balance and info
                        if(state.wallet.tokens.selected) {
                            await handleTokenSelect(state.wallet.tokens.selected.token.address);
                        }
                        }
                        
                        console.log('Post-transaction refresh completed.');
                    }, 1500);
                    }
                } else {
                    // Show error notification
                    const errorMsg = result?.message || result?.error || 'Transaction failed. Check console for details.';
                    showNotification('error', errorMsg);
                    console.error('Transaction failed', result);
                }
                } catch (err) {
                // Handle error case
                const submitButton = form.querySelector('button[type=submit]');
                if (submitButton && typeof originalText !== 'undefined') {
                    submitButton.disabled = false;
                    submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    submitButton.innerHTML = originalText;
                    lucide.createIcons();
                }
                showNotification('error', `Error: ${err.message}`);
                console.error('Transaction error', err);
                }
            });
            };

        // Add a notification system function
        // Add a notification system function
        const showNotification = (type, message) => {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-md transition-opacity duration-300 ${
            type === 'success' ? 'bg-green-500 text-white' : 
            type === 'warning' ? 'bg-yellow-500 text-white' : 
            'bg-red-500 text-white'
        }`;
        
        notification.innerHTML = `
            <div class="flex items-start gap-3">
            <i data-lucide="${type === 'success' ? 'check-circle' : type === 'warning' ? 'alert-triangle' : 'x-circle'}" class="w-5 h-5 flex-shrink-0"></i>
            <div class="flex-1">
                <p class="font-semibold">${type.charAt(0).toUpperCase() + type.slice(1)}</p>
                <p class="text-sm mt-1">${message}</p>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
            </div>
        `;
        
        document.body.appendChild(notification);
        lucide.createIcons();
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
        };

        const setupAllowanceForms = () => {
            document.getElementById('set-allowance-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const spender = document.getElementById('spender-address').value;
                const amount = parseFloat(document.getElementById('allowance-amount').value);
                if (!spender || isNaN(amount) || amount < 0) {
                    alert('Please enter a valid spender address and a non-negative amount.'); return;
                }
                const nonceData = await apiFetch(`/wallet/nonce?address=${config.identity.address}`, { authType: 'public' });
                const result = await apiFetch('/wallet/allowance/set', {
                    authType: 'user',
                    body: { spender, amount, nonce: nonceData.nonce + 1 }
                });
                if (result && result.transactionId) {
                    alert(`Set allowance transaction submitted! TxID: ${result.transactionId}`);
                    e.target.reset();
                } else {
                    alert(`Failed to set allowance: ${result.message || 'An error occurred.'}`);
                }
            });

            document.getElementById('check-allowance-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const spender = document.getElementById('query-spender-address').value;
                if (!spender) { alert('Please enter a spender address to check.'); return; }
                const result = await apiFetch(`/wallet/allowance?owner=${config.identity.address}&spender=${spender}`, { authType: 'public' });
                const resultContainer = document.getElementById('allowance-result-container');

                if (result && typeof result.allowance !== 'undefined') {
                    state.wallet.allowanceSpender = spender; // Store for removal
                    resultContainer.innerHTML = `
                        <div class="bg-blue-50 border border-blue-200 p-4 rounded-md">
                            <p class="text-sm">Allowance for <strong class="font-mono">${spender.substring(0,12)}...</strong></p>
                            <p class="text-2xl font-bold text-blue-800">${result.allowance.toFixed(4)} GCU</p>
                            <button id="remove-allowance-btn" class="mt-3 w-full bg-red-500 text-white font-bold py-2 px-4 rounded-md hover:bg-red-600 flex items-center justify-center gap-2">${renderIcon('trash-2', 'w-5 h-5')}Remove Allowance</button>
                        </div>`;
                    lucide.createIcons();
                    document.getElementById('remove-allowance-btn').addEventListener('click', handleRemoveAllowance);
                } else {
                    resultContainer.innerHTML = `<p class="text-sm text-gray-500">Could not retrieve allowance for that spender.</p>`;
                }
            });
        };
        
        const handleRemoveAllowance = async () => {
            const spender = state.wallet.allowanceSpender;
            if (!spender || !confirm(`Are you sure you want to remove all allowance for spender ${spender}?`)) return;

            const nonceData = await apiFetch(`/wallet/nonce?address=${config.identity.address}`, { authType: 'public' });
            const result = await apiFetch('/wallet/allowance/remove', {
                authType: 'user',
                body: { spender, nonce: nonceData.nonce + 1 }
            });
            if (result && result.transactionId) {
                alert(`Remove allowance transaction submitted! TxID: ${result.transactionId}`);
                document.getElementById('allowance-result-container').innerHTML = '';
                document.getElementById('query-spender-address').value = '';
                state.wallet.allowanceSpender = '';
            } else {
                alert(`Failed to remove allowance: ${result.message || 'An error occurred.'}`);
            }
        };

        const renderWalletHistoryContainer = () => {
             const container = document.getElementById('wallet-history-content');
             container.innerHTML = `
                <div class="bg-white rounded-xl">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <h3 class="text-lg font-bold text-dark flex items-center">
                            ${renderIcon('history', 'w-6 h-6 mr-3 text-blue-600')} Transaction History
                        </h3>
                        <div class="flex items-center gap-4 flex-col sm:flex-row w-full sm:w-auto">
                             <div class="relative flex-grow w-full sm:w-auto">
                                <i data-lucide="search" class="w-5 h-5 text-gray-400 absolute top-1/2 left-3 -translate-y-1/2"></i>
                                <input type="text" id="wallet-history-search" placeholder="Search history..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-600 focus:border-blue-600">
                            </div>
                            <div class="flex items-center gap-2">
                                <label for="wallet-history-timeframe" class="text-sm font-medium">Period:</label>
                                <select id="wallet-history-timeframe" class="border-gray-300 rounded-md shadow-sm focus:ring-blue-600 focus:border-blue-600 text-sm py-2">
                                    <option value="all">All Time</option>
                                    <option value="5m">Last 5 minutes</option>
                                    <option value="15m">Last 15 minutes</option>
                                    <option value="1h">Last 1 hour</option>
                                    <option value="24h" selected>Last 24 hours</option>
                                    <option value="7d">Last 7 days</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div id="wallet-history-container"></div>
                    <div id="wallet-history-pagination" class="mt-4 flex justify-between items-center text-sm"></div>
                </div>
             `;
             lucide.createIcons();
             document.getElementById('wallet-history-timeframe').addEventListener('change', (e) => {
                state.wallet.timeframeFilter = e.target.value;
                fetchWalletHistory(1);
            });

            document.getElementById('wallet-history-search').addEventListener('input', (e) => {
                state.search.wallet = e.target.value.toLowerCase();
                applyHistorySearchFilter();
            });
        };
        
        const fetchWalletData = async () => {
            const [balanceData, nonceData, stakeInfoData] = await Promise.all([
                apiFetch(`/wallet/balance?address=${config.identity.address}`, { authType: 'public' }),
                apiFetch(`/wallet/nonce?address=${config.identity.address}`, { authType: 'public' }),
                apiFetch(`/staking/status?owner_address=${config.identity.address}`, { authType: 'public' })
            ]);

            const balanceEl = document.getElementById('wallet-balance');
            const nonceEl = document.getElementById('wallet-nonce');
            if (balanceEl && balanceData && typeof balanceData.balance !== 'undefined') {
                balanceEl.textContent = (balanceData.balance || 0).toFixed(4);
            }
            if (nonceEl && nonceData && typeof nonceData.nonce !== 'undefined') {
                nonceEl.textContent = nonceData.nonce + 1;
            }

            const stakingContainer = document.getElementById('staking-info');
            if (!deepEqual(state.wallet.stakeInfo, stakeInfoData)) {
                state.wallet.stakeInfo = stakeInfoData;
                if (stakingContainer && stakeInfoData) {
                    const totalStake = stakeInfoData.totalStake || 0;
                    const allocations = stakeInfoData.allocations || [];
                    const unbonding = stakeInfoData.unbonding || [];
                    
                    let allocatedAmount = 0;
                    allocations.forEach(a => allocatedAmount += a.amount);

                    let unbondingAmount = 0;
                    unbonding.forEach(u => unbondingAmount += u.amount);

                    const availableStake = totalStake - allocatedAmount - unbondingAmount;

                    stakingContainer.innerHTML = `
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div class="bg-blue-50 p-2 rounded-lg"><div class="text-xs text-blue-700">Total Staked</div><div class="font-bold text-blue-900">${totalStake.toFixed(4)}</div></div>
                            <div class="bg-green-50 p-2 rounded-lg"><div class="text-xs text-green-700">Available</div><div class="font-bold text-green-900">${availableStake.toFixed(4)}</div></div>
                            <div class="bg-yellow-50 p-2 rounded-lg"><div class="text-xs text-yellow-700">Unbonding</div><div class="font-bold text-yellow-900">${unbondingAmount.toFixed(4)}</div></div>
                        </div>
                        <div class="mt-4">
                            <h4 class="font-semibold text-dark">Allocated Stake (${allocatedAmount.toFixed(4)} GCU)</h4>
                            <div id="allocations-list" class="mt-2 space-y-2 text-xs max-h-40 overflow-y-auto pr-2">
                                ${allocations.length > 0 ? allocations.map(a => `
                                    <div class="flex justify-between items-center bg-gray-100 p-2 rounded">
                                        <div class="font-mono truncate" title="${a.nodePeerId}"><i data-lucide="server" class="w-3 h-3 inline mr-2"></i>${a.nodePeerId.substring(0,12)}...</div>
                                        <div class="flex items-center">
                                            <span class="font-semibold mr-3">${a.amount.toFixed(4)} GCU</span>
                                            <button class="unassign-btn bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200" data-peer-id="${a.nodePeerId}">Unassign</button>
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-gray-500">No stake allocated to nodes.</p>'}
                            </div>
                        </div>
                         <div class="mt-4">
                            <h4 class="font-semibold text-dark">Unbonding Stake (${unbondingAmount.toFixed(4)} GCU)</h4>
                            <div id="unbonding-list" class="mt-2 space-y-2 text-xs max-h-40 overflow-y-auto pr-2">
                                 ${unbonding.length > 0 ? unbonding.map(u => {
                                    const unlockTime = new Date(u.unlockTime);
                                    const now = new Date();
                                    const timeLeft = unlockTime > now ? Math.round((unlockTime - now) / (1000 * 60 * 60)) + ' hours left' : 'Ready';
                                    return `<div class="flex justify-between items-center bg-gray-100 p-2 rounded">
                                        <span class="font-semibold">${u.amount.toFixed(4)} GCU</span>
                                        <span class="font-mono text-gray-500" title="${unlockTime.toLocaleString()}">${timeLeft}</span>
                                    </div>`
                                 }).join('') : '<p class="text-gray-500">No funds in unbonding period.</p>'}
                            </div>
                        </div>
                    `;
                    lucide.createIcons();
                }
            }
        };

        const fetchWalletHistory = async () => {
            const { address } = config.identity;
            
            const timeframe = state.wallet.timeframeFilter;
            const now = new Date();
            let start;
            if (timeframe !== 'all') {
                switch (timeframe) {
                    case '5m': start = new Date(now.getTime() - 5 * 60 * 1000); break;
                    case '15m': start = new Date(now.getTime() - 15 * 60 * 1000); break;
                    case '1h': start = new Date(now.getTime() - 60 * 60 * 1000); break;
                    case '7d': start = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000); break;
                    case '24h': default: start = new Date(now.getTime() - 24 * 60 * 60 * 1000); break;
                }
            }

            // Fetch ALL transactions for the timeframe (no pagination from server)
            let endpoint = `/wallet/history?address=${address}&page=1&limit=10000`;
            if (start) {
                endpoint += `&start=${start.toISOString()}&end=${now.toISOString()}`;
            }

            const historyData = await apiFetch(endpoint, { authType: 'public' });
            const newHistory = historyData.transactions || [];

            // Fetch token history separately
            const tokenHistoryEndpoint = `/token/history?address=${address}&page=1&limit=10000`;
            const tokenHistoryData = await apiFetch(tokenHistoryEndpoint, { authType: 'public' });
            const tokenHistory = (tokenHistoryData && tokenHistoryData.history) ? tokenHistoryData.history : [];

            // Create a map of token transactions by txHash
            const tokenTxMap = {};
            tokenHistory.forEach(th => {
                tokenTxMap[th.txHash] = th;
            });

            // Merge token data into ledger history
            const mergedHistory = newHistory.map(tx => {
                const tokenTx = tokenTxMap[tx.id];
                
                if (tokenTx) {
                    return {
                        ...tx,
                        isTokenTx: true,
                        tokenInfo: {
                            tokenAddress: tokenTx.tokenAddress,
                            tokenName: tokenTx.tokenName,
                            tokenTicker: tokenTx.tokenTicker,
                            operation: tokenTx.operation,
                            amount: tokenTx.amount,
                            amountRaw: tokenTx.amountRaw,
                            decimals: 6
                        }
                    };
                }
                return tx;
            });

            // Cache token details
            const tokenAddressesInHistory = [...new Set(
                mergedHistory
                    .filter(tx => tx.tokenInfo?.tokenAddress)
                    .map(tx => tx.tokenInfo.tokenAddress)
            )];
            
            const addressesToFetch = tokenAddressesInHistory.filter(addr => !state.wallet.tokens.detailsCache[addr]);

            if (addressesToFetch.length > 0) {
                await Promise.all(addressesToFetch.map(async (addr) => {
                    const tokenInfo = await apiFetch(`/token/info?address=${addr}`, {authType: 'public'});
                    if (tokenInfo && !tokenInfo.error) {
                        state.wallet.tokens.detailsCache[addr] = tokenInfo;
                    }
                }));
            }

            // Update decimals from cache
            mergedHistory.forEach(tx => {
                if (tx.tokenInfo?.tokenAddress && state.wallet.tokens.detailsCache[tx.tokenInfo.tokenAddress]) {
                    tx.tokenInfo.decimals = state.wallet.tokens.detailsCache[tx.tokenInfo.tokenAddress].decimals;
                }
            });

            // Store ALL history for the selected timeframe
            state.wallet.history = mergedHistory;
            
            // Reset to page 1
            state.wallet.currentPage = 1;
            
            // Apply search filter (if any) and render
            applyHistorySearchFilter();
        };

        const applyHistorySearchFilter = () => {
            const searchTerm = state.search.wallet || '';
            
            if (!searchTerm) {
                state.wallet.filteredHistory = state.wallet.history;
            } else {
                state.wallet.filteredHistory = state.wallet.history.filter(tx => {
                    const standardMatch = (tx.id && tx.id.toLowerCase().includes(searchTerm)) ||
                        (tx.type && tx.type.toLowerCase().includes(searchTerm)) ||
                        (tx.from && tx.from.toLowerCase().includes(searchTerm)) ||
                        (tx.to && tx.to.toLowerCase().includes(searchTerm));
                    
                    const tokenMatch = tx.tokenInfo && (
                        tx.tokenInfo.tokenName.toLowerCase().includes(searchTerm) ||
                        tx.tokenInfo.tokenTicker.toLowerCase().includes(searchTerm) ||
                        tx.tokenInfo.tokenAddress.toLowerCase().includes(searchTerm)
                    );
                    
                    return standardMatch || tokenMatch;
                });
            }
            
            // Reset to page 1 whenever filter changes
            state.wallet.currentPage = 1;
            renderWalletHistory();
        };
        
        const setupTransactionForm = (formId, endpoint) => {
            const form = document.getElementById(formId);
            if (!form) return;
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const amountInput = form.querySelector('input[type="number"]');
                const amount = amountInput ? parseFloat(amountInput.value) : 0;
                
                if (amountInput && (isNaN(amount) || amount <= 0)) { alert("Invalid amount"); return; }
                
                try {
                    const nonceData = await apiFetch(`/wallet/nonce?address=${config.identity.address}`, { authType: 'public' });
                    let payload = { nonce: nonceData.nonce + 1 };
                    
                    if (form.querySelector('#to-address')) payload.to = form.querySelector('#to-address').value;
                    if (amountInput) payload.amount = amount;
                    if (form.querySelector('#assign-node-id')) payload.nodePeerId = form.querySelector('#assign-node-id').value;
                    
                    const result = await apiFetch(endpoint, { authType: 'user', body: payload });
                    
                    if (result && result.transactionId) {
                        alert(`Transaction submitted successfully! TxID: ${result.transactionId}`);
                        setTimeout(() => {
                            fetchWalletData();
                            fetchWalletHistory(1);
                        }, 500); // Small delay to allow node to process
                        e.target.reset();
                    } else {
                        alert(`Transaction failed: ${result.message || 'Check console for details.'}`);
                    }
                } catch (err) {
                    alert(`Error during transaction: ${err.message}`);
                }
            });
        };

        const renderWalletHistory = () => {
            const container = document.getElementById('wallet-history-container');
            const paginationContainer = document.getElementById('wallet-history-pagination');
            
            if (!container || !paginationContainer) return;

            // Use filtered history (which may be same as full history if no search)
            const displayHistory = state.wallet.filteredHistory || state.wallet.history;
            
            // Client-side pagination
            const itemsPerPage = state.wallet.limit;
            const currentPage = state.wallet.currentPage;
            const totalPages = Math.ceil(displayHistory.length / itemsPerPage);
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedHistory = displayHistory.slice(startIndex, endIndex);

            if (!paginatedHistory || paginatedHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-12 text-gray-500">
                        <div class="text-3xl mb-4">${renderIcon('inbox')}</div>
                        No transaction history found.
                    </div>
                `;
                lucide.createIcons();
                paginationContainer.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${paginatedHistory.map(transaction => renderTransactionRow(transaction)).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            lucide.createIcons();

            // Render pagination controls
            const showingStart = startIndex + 1;
            const showingEnd = Math.min(endIndex, displayHistory.length);
            const totalRecords = displayHistory.length;

            // REVISED: Pagination with buttons on far right
            paginationContainer.innerHTML = `
                <div class="flex justify-between items-center w-full">
                    <div class="text-sm text-gray-600">
                        Showing ${showingStart}-${showingEnd} of ${totalRecords} transactions (Page ${currentPage} of ${totalPages})
                    </div>
                    <div class="flex items-center space-x-2">
                        ${currentPage > 1 ? `
                            <button onclick="state.wallet.currentPage = ${currentPage - 1}; renderWalletHistory();" 
                                    class="px-4 py-2 border rounded-md bg-white hover:bg-gray-50 text-sm font-medium">
                                Prev
                            </button>
                        ` : ''}
                        ${currentPage < totalPages ? `
                            <button onclick="state.wallet.currentPage = ${currentPage + 1}; renderWalletHistory();" 
                                    class="px-4 py-2 border rounded-md bg-white hover:bg-gray-50 text-sm font-medium">
                                Next
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        };

        const renderTransactionRow = (transaction) => {
            const isOutbound = transaction.from === config.identity.address;
            
            // Handle token transactions
            if (transaction.isTokenTx && transaction.tokenInfo) {
                const tokenInfo = transaction.tokenInfo;
                const operation = tokenInfo.operation || transaction.type;
                
                let amountDisplay = '';
                let amountClass = 'text-gray-600';
                
                // Determine amount display and color based on operation
                if (operation === 'CREATE') {
                    amountDisplay = `+ ${tokenInfo.amount.toFixed(tokenInfo.decimals)} ${tokenInfo.tokenTicker}`;
                    amountClass = 'text-green-600';
                } else if (operation === 'TRANSFER') {
                    if (isOutbound) {
                        amountDisplay = `- ${tokenInfo.amount.toFixed(tokenInfo.decimals)} ${tokenInfo.tokenTicker}`;
                        amountClass = 'text-red-600';
                    } else {
                        amountDisplay = `+ ${tokenInfo.amount.toFixed(tokenInfo.decimals)} ${tokenInfo.tokenTicker}`;
                        amountClass = 'text-green-600';
                    }
                } else if (operation === 'MINT') {
                    amountDisplay = `+ ${tokenInfo.amount.toFixed(tokenInfo.decimals)} ${tokenInfo.tokenTicker}`;
                    amountClass = 'text-green-600';
                } else if (operation === 'BURN') {
                    amountDisplay = `- ${tokenInfo.amount.toFixed(tokenInfo.decimals)} ${tokenInfo.tokenTicker}`;
                    amountClass = 'text-red-600';
                } else if (operation === 'APPROVE' && tokenInfo.amount > 0) {
                    amountDisplay = `${tokenInfo.amount.toFixed(tokenInfo.decimals)} ${tokenInfo.tokenTicker}`;
                    amountClass = 'text-blue-600';
                }
                // For CONFIG operations, no amount display
                
                const typeMap = {
                    'TRANSFER': {icon: 'arrow-right-left', color: 'bg-blue-100 text-blue-800'},
                    'MINT': {icon: 'plus', color: 'bg-green-100 text-green-800'},
                    'BURN': {icon: 'flame', color: 'bg-red-100 text-red-800'},
                    'APPROVE': {icon: 'user-check', color: 'bg-cyan-100 text-cyan-800'},
                    'CREATE': {icon: 'plus-circle', color: 'bg-purple-100 text-purple-800'},
                    'CONFIG_MINT': {icon: 'settings', color: 'bg-indigo-100 text-indigo-800'},
                    'CONFIG_BURN': {icon: 'settings', color: 'bg-orange-100 text-orange-800'},
                    'CONFIG_LOCK': {icon: 'lock', color: 'bg-gray-100 text-gray-800'},
                };
                
                const typeInfo = typeMap[operation] || {icon: 'coins', color: 'bg-purple-100 text-purple-800'};
                
                let details = `<div class="font-semibold">${tokenInfo.tokenName}</div>`;
                details += `<div class="text-xs text-gray-500 mt-1">Token: <button onclick="copyToClipboard('${tokenInfo.tokenAddress}', this)" class="inline-flex items-center gap-1 px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-700 transition font-mono text-xs">${tokenInfo.tokenAddress.substring(0, 12)}...${renderIcon('copy', 'w-3 h-3')}</button></div>`;
                
                if (operation === 'TRANSFER') {
                    if (isOutbound) {
                        details += `<div class="text-xs mt-1">To: <button onclick="copyToClipboard('${transaction.to}', this)" class="inline-flex items-center gap-1 px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-700 transition font-mono text-xs">${transaction.to?.substring(0, 12)}...${renderIcon('copy', 'w-3 h-3')}</button></div>`;
                    } else {
                        details += `<div class="text-xs mt-1">From: <button onclick="copyToClipboard('${transaction.from}', this)" class="inline-flex items-center gap-1 px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-700 transition font-mono text-xs">${transaction.from?.substring(0,12)}...${renderIcon('copy', 'w-3 h-3')}</button></div>`;
                    }
                } else if (operation === 'MINT' || operation === 'BURN') {
                    const addr = operation === 'MINT' ? transaction.to : transaction.from;
                    details += `<div class="text-xs mt-1">${operation === 'MINT' ? 'To' : 'From'}: <button onclick="copyToClipboard('${addr}', this)" class="inline-flex items-center gap-1 px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-700 transition font-mono text-xs">${addr?.substring(0,12)}...${renderIcon('copy', 'w-3 h-3')}</button></div>`;
                } else if (operation === 'APPROVE') {
                    details += `<div class="text-xs mt-1">Spender: <button onclick="copyToClipboard('${transaction.to}', this)" class="inline-flex items-center gap-1 px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-700 transition font-mono text-xs">${transaction.to?.substring(0,12)}...${renderIcon('copy', 'w-3 h-3')}</button></div>`;
                }
                
                const status = transaction.status || 'Confirmed';
                const statusDisplay = status === 'Confirmed' 
                    ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Confirmed</span>`
                    : status === 'Failed'
                    ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Failed</span>`
                    : `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">${status}</span>`;
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div>${new Date(transaction.timestamp).toLocaleDateString()}</div>
                            <div class="text-xs text-gray-500">${new Date(transaction.timestamp).toLocaleTimeString()}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex items-center text-xs leading-5 font-semibold rounded-full ${typeInfo.color}">
                                <i data-lucide="${typeInfo.icon}" class="w-3 h-3 mr-1 flex-shrink-0"></i>
                                ${operation.replace(/_/g, ' ')}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                            ${details}
                            <div class="text-xs text-gray-500 mt-2">TX: <button onclick="copyToClipboard('${transaction.id}', this)" class="inline-flex items-center gap-1 px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-700 transition font-mono text-xs">${transaction.id.substring(0,12)}...${renderIcon('copy', 'w-3 h-3')}</button></div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">${statusDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-right ${amountClass}">
                            ${amountDisplay}
                        </td>
                    </tr>
                `;
            }
            
            // Standard GCU transaction rendering
            let amountClass = 'text-gray-600';
            let amountSign = '';
            let displayAmount = '';
            
            if (['TRANSFER', 'DELEGATED_TRANSFER', 'DEBIT', 'STAKE_DEPOSIT', 'STAKE_WITHDRAWAL'].includes(transaction.type)) {
                if (transaction.amount > 0) {
                    amountClass = isOutbound ? 'text-red-600' : 'text-green-600';
                    amountSign = isOutbound ? '-' : '+';
                    displayAmount = `${amountSign} ${(transaction.amount || 0).toFixed(4)} GCU`;
                }
            } else if (transaction.type.includes('REWARD')) {
                amountClass = 'text-green-600';
                amountSign = '+';
                displayAmount = `${amountSign} ${(transaction.amount || 0).toFixed(4)} GCU`;
            } else if (transaction.type === 'GENESIS') {
                amountClass = 'text-green-600';
                amountSign = '+';
                displayAmount = `${amountSign} ${(transaction.amount || 0).toFixed(4)} GCU`;
            } else if (transaction.type === 'SET_ALLOWANCE' && transaction.allowance) {
                displayAmount = `${(transaction.allowance || 0).toFixed(4)} GCU`;
                amountClass = 'text-blue-600';
            }
            // For operations without amount (REMOVE_ALLOWANCE, STAKE_ASSIGN, etc), leave displayAmount empty

            const typeMap = {
                'TRANSFER': {icon: 'arrow-right-left', color: 'bg-blue-100 text-blue-800'},
                'STAKE_DEPOSIT': {icon: 'arrow-down-to-line', color: 'bg-green-100 text-green-800'},
                'STAKE_WITHDRAWAL': {icon: 'arrow-up-from-line', color: 'bg-red-100 text-red-800'},
                'STAKE_ASSIGN': {icon: 'link', color: 'bg-indigo-100 text-indigo-800'},
                'STAKE_UNASSIGN': {icon: 'unlink', color: 'bg-yellow-100 text-yellow-800'},
                'REWARD': {icon: 'award', color: 'bg-yellow-100 text-yellow-800'},
                'DEBIT': {icon: 'arrow-down', color: 'bg-red-100 text-red-800'},
                'GENESIS': {icon: 'sparkles', color: 'bg-purple-100 text-purple-800'},
                'SET_ALLOWANCE': {icon: 'user-check', color: 'bg-cyan-100 text-cyan-800'},
                'REMOVE_ALLOWANCE': {icon: 'user-x', color: 'bg-orange-100 text-orange-800'},
                'DELEGATED_TRANSFER': {icon: 'user-cog', color: 'bg-teal-100 text-teal-800'},
            };

            const typeInfo = typeMap[transaction.type] || {icon: 'help-circle', color: 'bg-gray-100 text-gray-800'};
            let typeDisplay = transaction.type.replace(/_/g, ' ');
            
            let details = '';
            if (['TRANSFER', 'DELEGATED_TRANSFER'].includes(transaction.type)) {
                if (isOutbound) {
                    details += `To: <button onclick="copyToClipboard('${transaction.to}', this)" class="inline-flex items-center gap-1 px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-700 transition font-mono text-xs">${transaction.to?.substring(0, 12)}...${renderIcon('copy', 'w-3 h-3')}</button>`;
                } else {
                    details += `From: <button onclick="copyToClipboard('${transaction.from}', this)" class="inline-flex items-center gap-1 px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-700 transition font-mono text-xs">${transaction.from?.substring(0,12)}...${renderIcon('copy', 'w-3 h-3')}</button>`;
                }
            } else if (['SET_ALLOWANCE', 'REMOVE_ALLOWANCE'].includes(transaction.type)) {
                details += `Spender: <button onclick="copyToClipboard('${transaction.to}', this)" class="inline-flex items-center gap-1 px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-700 transition font-mono text-xs">${transaction.to?.substring(0,12)}...${renderIcon('copy', 'w-3 h-3')}</button>`;
            } else if (transaction.targetNodeId) {
                details += `Node: <button onclick="copyToClipboard('${transaction.targetNodeId}', this)" class="inline-flex items-center gap-1 px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-700 transition font-mono text-xs">${transaction.targetNodeId.substring(0,12)}...${renderIcon('copy', 'w-3 h-3')}</button>`;
            } else {
                details = 'System Transaction';
            }
            
            const status = transaction.status || 'Confirmed';
            let statusDisplay = status === 'Confirmed' 
                ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Confirmed</span>`
                : status === 'Pending'
                ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>`
                : status === 'Failed'
                ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Failed</span>`
                : `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">${status}</span>`;

            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div>${new Date(transaction.timestamp).toLocaleDateString()}</div>
                        <div class="text-xs text-gray-500">${new Date(transaction.timestamp).toLocaleTimeString()}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex items-center text-xs leading-5 font-semibold rounded-full ${typeInfo.color}">
                            <i data-lucide="${typeInfo.icon}" class="w-3 h-3 mr-1 flex-shrink-0"></i>
                            ${typeDisplay}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">
                        <div>${details}</div>
                        <div class="text-xs text-gray-500 mt-1">TX: <button onclick="copyToClipboard('${transaction.id}', this)" class="inline-flex items-center gap-1 px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-700 transition font-mono text-xs">${transaction.id.substring(0,12)}...${renderIcon('copy', 'w-3 h-3')}</button></div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">${statusDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-right ${amountClass}">
                        ${displayAmount}
                    </td>
                </tr>
            `;
        };

        const renderLogging = () => {
            const container = document.getElementById('logging-tab');
            const isAdmin = config.authLevel === 'admin';
            
            const logTabs = [
                { id: 'live-logs', icon: 'radio-tower', label: 'Live', level: 'admin' },
                { id: 'gateway-logs', icon: 'arrow-left-right', label: 'Gateway', level: 'user' },
                { id: 'ledger-logs', icon: 'book-open', label: 'Ledger', level: 'user' },
                { id: 'schema-logs', icon: 'file-cog', label: 'Schema', level: 'admin' },
                { id: 'admin-logs', icon: 'shield', label: 'Admin', level: 'admin' },
            ];

            const visibleTabs = logTabs.filter(tab => {
                if (tab.level === 'admin' && isAdmin) return true;
                if (tab.level === 'user') return true;
                return false;
            });
            
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                    <div class="sub-tabs flex border-b border-gray-200 mb-4 overflow-x-auto">
                        ${visibleTabs.map(tab => `<button class="sub-tab flex-1 py-3 px-2 text-center font-semibold text-gray-500 hover:bg-gray-50 border-b-2 border-transparent transition whitespace-nowrap" data-subtab="${tab.id}"><i data-lucide="${tab.icon}" class="inline-block w-5 h-5 mr-2"></i>${tab.label}</button>`).join('')}
                    </div>
                    ${visibleTabs.map(tab => `<div class="sub-tab-content hidden" id="${tab.id}-content" ${tab.id !== 'live-logs' ? `data-log-type="${tab.id.replace('-logs', '')}"` : ''}></div>`).join('')}
                </div>`;
            
            container.querySelectorAll('.sub-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    container.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
                    container.querySelectorAll('.sub-tab-content').forEach(c => c.classList.add('hidden'));
                    tab.classList.add('active');
                    const contentId = `${tab.dataset.subtab}-content`;
                    const contentEl = document.getElementById(contentId);
                    contentEl.classList.remove('hidden');
                    
                    if (contentId === 'live-logs-content') {
                        if (!contentEl.innerHTML) renderLiveLogs();
                    } else if (contentEl.dataset.logType) {
                        // Always render when switching tabs to ensure fresh state
                        renderHistoricalLogViewer(contentEl.dataset.logType);
                    }
                });
            });
            
            const firstTab = container.querySelector('.sub-tab');
            if (firstTab) firstTab.click();
        };

        const renderLiveLogs = () => {
            const container = document.getElementById('live-logs-content');
            if (!container) return;
            if (config.authLevel !== 'admin') {
                container.innerHTML = `<div class="text-center p-12 text-gray-500"><div class="text-3xl mb-4">${renderIcon('shield-off')}</div>Live logs are only available for Node Operators.</div>`;
                lucide.createIcons();
                return;
            }
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <select id="live-log-type-filter" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-600 focus:border-blue-600">
                        <option value="all" selected>All Log Types</option>
                        <option value="gateway">Gateway</option>
                        <option value="schema">Schema</option>
                        <option value="admin">Admin</option>
                        <option value="ledger">Ledger</option>
                    </select>
                    <select id="live-log-service-filter" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-600 focus:border-blue-600 hidden md:col-span-2"></select>
                </div>
                <div class="log-container bg-dark text-light p-4 sm:p-6 rounded-lg shadow-inner h-[600px] overflow-y-auto" id="live-log-container"></div>`;
            
            document.getElementById('live-log-type-filter').addEventListener('change', (e) => {
                state.live.logTypeFilter = e.target.value;
                document.getElementById('live-log-service-filter').style.display = (e.target.value === 'gateway' || e.target.value === 'schema') ? 'block' : 'none';
            });
            document.getElementById('live-log-service-filter').addEventListener('change', (e) => {
                state.live.serviceFilter = e.target.value;
            });
            populateServiceFilters();
            connectToLogStream();
        };

        const renderHistoricalLogViewer = (logType) => {
            const container = document.getElementById(`${logType}-logs-content`);
            if (!container) return;
            
            // Initialize state if not exists
            if (!state.logs[logType]) {
                state.logs[logType] = {
                    data: [],
                    filtered: [],
                    currentPage: 1,
                    logsPerPage: 20,
                    query: '',
                    serviceFilter: 'all',
                    timeframe: '24h'
                };
            }
            
            const isUserView = config.authLevel === 'user';
            const hasServiceFilter = (logType === 'gateway' || logType === 'schema') && !isUserView;
            
            container.innerHTML = `
                <div class="historical-controls grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <select class="timeframe-selector w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-600 focus:border-blue-600">
                        <option value="5m">Last 5 minutes</option>
                        <option value="15m">Last 15 minutes</option>
                        <option value="1h">Last 1 hour</option>
                        <option value="24h" selected>Last 24 hours</option>
                        <option value="7d">Last 7 days</option>
                    </select>
                    ${hasServiceFilter ? `<select class="service-name-filter w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-600 focus:border-blue-600"></select>` : '<div></div>'}
                    <input type="text" class="keyword-search w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-600 focus:border-blue-600 ${hasServiceFilter ? '' : 'md:col-span-2'}" placeholder="Search logs..." value="${state.logs[logType].query || ''}">
                    <button class="refresh-logs-btn bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 flex items-center justify-center">
                        <i data-lucide="refresh-cw" class="w-5 h-5 mr-2"></i>Refresh
                    </button>
                </div>
                ${isUserView ? `<p class="text-sm text-gray-600 mb-4 bg-blue-50 border border-blue-200 p-3 rounded-md">Displaying only logs associated with your address: <span class="font-mono text-blue-800">${config.identity.address}</span></p>` : ''}
                <div class="log-container bg-white border border-gray-200 rounded-lg shadow-inner h-[600px] overflow-y-auto historical-log-container"></div>
                <div class="pagination-controls flex justify-between items-center mt-4"></div>`;
            
            if (hasServiceFilter) {
                populateServiceFilters();
                const serviceFilter = container.querySelector('.service-name-filter');
                if (serviceFilter) {
                    serviceFilter.value = state.logs[logType].serviceFilter || 'all';
                    serviceFilter.addEventListener('change', (e) => {
                        state.logs[logType].serviceFilter = e.target.value;
                        applyHistoricalFilters(logType);
                    });
                }
            }

            // Set timeframe to saved value
            const timeframeSelector = container.querySelector('.timeframe-selector');
            if (timeframeSelector) {
                timeframeSelector.value = state.logs[logType].timeframe || '24h';
                timeframeSelector.addEventListener('change', (e) => {
                    state.logs[logType].timeframe = e.target.value;
                    fetchHistoricalLogs(logType);
                });
            }

            container.querySelector('.refresh-logs-btn').addEventListener('click', () => fetchHistoricalLogs(logType));
            container.querySelector('.keyword-search').addEventListener('input', (e) => {
                state.logs[logType].query = e.target.value;
                applyHistoricalFilters(logType);
            });

            lucide.createIcons();
            
            // Fetch logs immediately when rendering
            fetchHistoricalLogs(logType);
        };

        const renderLogEntry = (logData, logContainer) => {
            const isLive = logContainer.id === 'live-log-container';
            
            if (isLive) {
                if (state.live.logTypeFilter !== 'all' && logData.log_type !== state.live.logTypeFilter) return;
                if ((logData.log_type === 'gateway' || logData.log_type === 'schema') && state.live.serviceFilter !== 'all') {
                    if (logData.log_type === 'gateway' && !serviceInGatewayLog(logData, state.live.serviceFilter)) return;
                    if (logData.log_type === 'schema' && logData.schema_name !== state.live.serviceFilter) return;
                }
            }
            
            const { timestamp, trace_id, log_type, client_request, client_response } = logData;
            
            let statusColor = 'border-gray-300';
            let statusIcon, mainTitle, subTitle;

            switch(log_type) {
                case 'gateway':
                    const isError = logData.failure_message || (client_response && client_response.status_code >= 400);
                    const status = client_response?.status_code || 'ERR';
                    statusColor = isError ? 'border-red-500' : 'border-green-500';
                    statusIcon = `<div class="w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full ${isError ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'} mr-4 font-bold text-sm">${status}</div>`;
                    mainTitle = `<span class="font-bold text-dark">${client_request?.method || ''}</span> <span class="font-mono text-gray-600">${client_request?.url || 'N/A'}</span>`;
                    subTitle = `From: <span class="font-mono text-blue-600">${logData.request_address}</span> | User: <span class="font-mono text-blue-600">${logData.user || 'anonymous'}</span>`;
                    break;
                case 'schema':
                    statusColor = 'border-blue-500';
                    statusIcon = `<div class="w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full bg-blue-100 text-blue-600 mr-4">${renderIcon('file-cog', 'w-6 h-6')}</div>`;
                    mainTitle = `<span class="font-bold text-dark">Schema Change</span>`;
                    subTitle = `Service: <span class="font-mono text-blue-600">${logData.schema_name}</span> | Triggered by: <span class="font-mono text-blue-600">${logData.schema_change_info?.triggered_by || 'N/A'}</span>`;
                    break;
                case 'admin':
                    statusColor = 'border-purple-500';
                    statusIcon = `<div class="w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full bg-purple-100 text-purple-600 mr-4">${renderIcon('shield', 'w-6 h-6')}</div>`;
                    mainTitle = `<span class="font-bold text-dark">Admin Action</span>`;
                    subTitle = `Activity: <span class="font-mono text-blue-600">${logData.activity || client_request?.url || 'N/A'}</span>`;
                    break;
                case 'ledger':
                    statusColor = 'border-yellow-500';
                    statusIcon = `<div class="w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full bg-yellow-100 text-yellow-600 mr-4">${renderIcon('book-open', 'w-6 h-6')}</div>`;
                    mainTitle = `<span class="font-bold text-dark">Ledger Event:</span> <span class="font-mono text-gray-700">${logData.activity || 'Transaction'}</span>`;
                    subTitle = `User: <span class="font-mono text-blue-600">${logData.user}</span> | TxID: <span class="font-mono text-blue-600" title="${logData.transaction_info?.transactionId}">${logData.transaction_info?.transactionId.substring(0,12) || 'N/A'}...</span>`;
                    break;
            }

            const entry = document.createElement('div');
            entry.className = `log-entry group bg-white border-l-4 ${statusColor} p-3 my-2 rounded-lg shadow-sm text-sm`;
            entry.innerHTML = `<div class="flex justify-between items-center cursor-pointer" onclick="this.parentElement.classList.toggle('open')">
                <div class="flex items-center min-w-0">
                    ${statusIcon}
                    <div class="min-w-0">
                        <p class="truncate text-md">${mainTitle}</p>
                        <p class="text-xs text-gray-500 truncate">${subTitle}</p>
                    </div>
                </div>
                <div class="flex items-center flex-shrink-0 ml-4">
                    <span class="font-mono text-xs text-gray-400 mr-4">${new Date(timestamp || Date.now()).toLocaleString()}</span>
                    <i data-lucide="chevron-down" class="w-5 h-5 group-chevron text-gray-400 transition-transform"></i>
                </div>
            </div>
            <div class="collapsible-content">
                <div class="mt-3 pt-3 border-t border-gray-200 text-gray-800 space-y-3 details-container"></div>
            </div>`;
            
            entry.querySelector('.details-container').innerHTML = renderLogDetails(logData);
            attachLogDetailButtonListeners(entry, logData);
            
            if (isLive) {
                logContainer.prepend(entry);
                if (logContainer.children.length > 200) logContainer.removeChild(logContainer.lastChild);
            } else {
                logContainer.appendChild(entry);
            }
            lucide.createIcons();
        };
        const attachLogDetailButtonListeners = (entryElement, logData) => {
            const bindClick = (selector, title, dataProvider) => {
                const button = entryElement.querySelector(selector);
                if (button) {
                    const data = dataProvider();
                    if (data && (typeof data !== 'object' || Object.keys(data).length > 0)) {
                        button.addEventListener('click', () => {
                            const content = `<pre class="bg-dark text-light p-4 rounded-md text-xs whitespace-pre-wrap"><code class="language-json">${syntaxHighlight(data)}</code></pre>`;
                            showDetailsModal(title, content);
                        });
                    } else {
                        button.disabled = true;
                        button.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                }
            };
        
            switch(logData.log_type) {
                case 'gateway':
                    bindClick('.client-req-btn', 'Client Request', () => logData.client_request);
                    bindClick('.client-res-btn', 'Client Response', () => logData.client_response);
                    bindClick('.downstream-req-btn', 'Downstream Request', () => logData.downstream_request);
                    bindClick('.downstream-res-btn', 'Downstream Response', () => logData.downstream_response);
        
                    entryElement.querySelectorAll('.pipeline-req-btn, .pipeline-res-btn').forEach(btn => {
                        const { pStepType, pStepIndex } = btn.dataset;
                        const step = logData[pStepType]?.[pStepIndex];
                        if (step) {
                            const isReq = btn.classList.contains('pipeline-req-btn');
                            const title = `${isReq ? 'Request to' : 'Response from'} ${step.service}`;
                            const data = isReq ? step.request : step.response;
                            btn.addEventListener('click', () => {
                                const content = `<pre class="bg-dark text-light p-4 rounded-md text-xs whitespace-pre-wrap"><code class="language-json">${syntaxHighlight(data)}</code></pre>`;
                                showDetailsModal(title, content);
                            });
                        }
                    });
                    break;
                case 'schema':
                    bindClick('.schema-req-btn', 'Triggering Request', () => safeJsonParse(logData.schema_change_info?.triggering_request));
                    break;
                case 'admin':
                    bindClick('.admin-req-btn', 'Full Admin Request', () => logData.client_request);
                    break;
            }
        };

        const renderLogDetails = (logData) => {
            switch(logData.log_type) {
                case 'gateway': return renderGatewayLogDetails(logData);
                case 'schema': return renderSchemaLogDetails(logData);
                case 'admin': return renderAdminLogDetails(logData);
                case 'ledger': return `<pre class="bg-dark text-light p-4 rounded-md text-xs whitespace-pre-wrap"><code class="language-json">${syntaxHighlight(logData.transaction_info)}</code></pre>`;
                default: return `<div class="font-mono text-gray-500 p-2 bg-gray-100 rounded">${logData.failure_message || 'No details.'}</div>`;
            }
        };
        const renderGatewayLogDetails = (logData) => {
            const { failure_message, downstream_request } = logData;
            
            const renderPipelineStepsInLog = (title, steps, stepType, colorClass) => {
                if (!steps || steps.length === 0) return '';
                return `<div class="mt-3">
                        <strong class="text-sm font-semibold ${colorClass}">${title} (${steps.length})</strong>
                        <div class="pl-4 mt-1 space-y-2">${steps.map((step, index) => `<div class="p-2 bg-gray-100 rounded-md border border-gray-200"><div class="flex justify-between items-center text-xs"><span class="font-mono font-semibold">${step.service}/${step.field || step.path}</span><div>${step.concurrent ? `<span class="ml-2 text-xs font-bold text-purple-600 bg-purple-100 px-2 py-0.5 rounded-full" title="Concurrent">Async</span>` : ''}<button class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded pipeline-req-btn" data-p-step-type="${stepType}" data-p-step-index="${index}">Req</button><button class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded ml-1 pipeline-res-btn" data-p-step-type="${stepType}" data-p-step-index="${index}">Res</button></div></div>${step.error ? `<div class="mt-1 text-red-600 text-xs truncate" title="${step.error}"><strong>Error:</strong> ${step.error}</div>` : ''}</div>`).join('')}</div>
                    </div>`;
            };

            return `${failure_message ? `<div class="font-mono text-red-500 p-2 bg-red-100 rounded"><strong>Failure Reason:</strong> ${failure_message}</div>` : ''}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <strong class="text-sm font-semibold">Client Traffic</strong>
                            <div class="flex gap-2 mt-1">
                               <button class="text-sm bg-gray-200 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-300 w-full text-left client-req-btn">Client Request</button>
                               <button class="text-sm bg-gray-200 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-300 w-full text-left client-res-btn">Client Response</button>
                            </div>
                        </div>
                        ${downstream_request && downstream_request.url ? `
                            <div>
                                <strong class="text-sm font-semibold">Main Endpoint Execution</strong>
                                <div class="flex gap-2 mt-1">
                                    <button class="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-md hover:bg-blue-200 w-full text-left downstream-req-btn">Downstream Req</button>
                                    <button class="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-md hover:bg-blue-200 w-full text-left downstream-res-btn">Downstream Res</button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    ${renderPipelineStepsInLog('Pre-flight Success', logData.pre_success_steps, 'pre_success_steps', 'text-green-600')}
                    ${renderPipelineStepsInLog('Pre-flight Failure', logData.pre_failure_steps, 'pre_failure_steps', 'text-red-600')}
                    ${renderPipelineStepsInLog('Post-flight Success', logData.post_success_steps, 'post_success_steps', 'text-green-600')}
                    ${renderPipelineStepsInLog('Post-flight Failure', logData.post_failure_steps, 'post_failure_steps', 'text-red-600')}
                    ${renderPipelineStepsInLog('Rollback Success', logData.rollback_success, 'rollback_success', 'text-yellow-600')}
                    ${renderPipelineStepsInLog('Rollback Failure', logData.rollback_failure, 'rollback_failure', 'text-red-600')}`;
        };
        const renderSchemaLogDetails = (logData) => {
            const { schema_change_info } = logData;
            if (!schema_change_info) return 'No schema change details available.';
            const diffHTML = generateDiff(schema_change_info.schema_before, schema_change_info.schema_after);
            return `<div class="space-y-3">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
                            <div class="p-2 bg-gray-100 rounded-md"><div class="text-xs text-gray-500">Triggered By</div><div class="font-mono font-semibold">${schema_change_info.triggered_by || 'N/A'}</div></div>
                            <div class="p-2 bg-gray-100 rounded-md"><div class="text-xs text-gray-500">Change Detected</div><div class="font-mono font-semibold">${schema_change_info.is_changed ? 'Yes' : 'No'}</div></div>
                             <div class="p-2 bg-gray-100 rounded-md"><div class="text-xs text-gray-500">New Version</div><div class="font-mono font-semibold">v${schema_change_info.version || 'N/A'}</div></div>
                            <div class="p-2 ${schema_change_info.blue_green_swap ? 'bg-green-100' : 'bg-gray-100'} rounded-md"><div class="text-xs text-gray-500">Blue/Green Swap</div><div class="font-mono font-semibold">${schema_change_info.blue_green_swap ? 'Success' : 'N/A'}</div></div>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-md max-h-96 overflow-y-auto"><div class="font-mono text-sm p-2">${diffHTML}</div></div>
                        <div><button class="text-sm bg-gray-200 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-300 schema-req-btn">View Full Request</button></div>
                    </div>`;
        };
        const renderAdminLogDetails = (logData) => {
            const { admin_activity_info } = logData;
            if (!admin_activity_info) return 'No admin activity details available.';
            return `<div class="space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div class="p-2 bg-gray-100 rounded-md"><div class="text-xs text-gray-500">Accessed By (IP)</div><div class="font-mono font-semibold">${admin_activity_info.accessed_by || 'N/A'}</div></div>
                            <div class="p-2 bg-gray-100 rounded-md"><div class="text-xs text-gray-500">Admin Address</div><div class="font-mono font-semibold truncate">${logData.client_request?.headers?.['X-Grapthway-Admin-Address']?.[0] || 'N/A'}</div></div>
                        </div>
                        <div><button class="text-sm bg-gray-200 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-300 admin-req-btn">View Full Request</button></div>
                    </div>`;
        };

        const renderHistoricalLogs = (logType) => {
            const logState = state.logs[logType];
            const contentEl = document.getElementById(`${logType}-logs-content`);
            if (!contentEl) return;
            
            const container = contentEl.querySelector('.historical-log-container');
            const paginationContainer = contentEl.querySelector('.pagination-controls');
            
            if (!container || !paginationContainer) return;
            
            container.innerHTML = '';
            paginationContainer.innerHTML = '';
            
            const { logsPerPage, currentPage, filtered } = logState;
            
            if (!filtered || filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-12 text-gray-500">
                        <div class="text-3xl mb-4">${renderIcon('search-x')}</div>
                        No logs found for the selected criteria.
                    </div>`;
                lucide.createIcons();
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(filtered.length / logsPerPage);
            const start = (currentPage - 1) * logsPerPage;
            const end = Math.min(start + logsPerPage, filtered.length);
            const paginatedLogs = filtered.slice(start, end);
            
            // Render logs
            paginatedLogs.forEach(log => renderLogEntry(log, container));
            
            // Render pagination controls
            paginationContainer.innerHTML = `
                <div class="text-sm text-gray-600">
                    Showing ${start + 1}-${end} of ${filtered.length} logs (Page ${currentPage} of ${totalPages})
                </div>
                <div class="flex items-center gap-2">
                    <button ${currentPage === 1 ? 'disabled' : ''} 
                            onclick="changeLogPage('${logType}', ${currentPage - 1})" 
                            class="px-3 py-1 border rounded-md bg-white disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50">
                        Prev
                    </button>
                    <span class="text-sm text-gray-600">Page ${currentPage} of ${totalPages}</span>
                    <button ${currentPage === totalPages ? 'disabled' : ''} 
                            onclick="changeLogPage('${logType}', ${currentPage + 1})" 
                            class="px-3 py-1 border rounded-md bg-white disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50">
                        Next
                    </button>
                </div>`;
        };

        window.changeLogPage = (logType, page) => {
            if (!state.logs[logType]) return;
            
            const totalPages = Math.ceil(state.logs[logType].filtered.length / state.logs[logType].logsPerPage);
            
            // Validate page number
            if (page < 1 || page > totalPages) return;
            
            state.logs[logType].currentPage = page;
            renderHistoricalLogs(logType);
            
            // Scroll to top of log container
            const contentEl = document.getElementById(`${logType}-logs-content`);
            if (contentEl) {
                const container = contentEl.querySelector('.historical-log-container');
                if (container) container.scrollTop = 0;
            }
        };
        
        const serviceInGatewayLog = (log, serviceFilter) => {
            if (log.subgraph === serviceFilter) return true;
            const pipelineSteps = [...(log.pre_success_steps || []), ...(log.pre_failure_steps || []), ...(log.post_success_steps || []), ...(log.post_failure_steps || [])];
            return pipelineSteps.some(step => step.service === serviceFilter);
        };

        const applyHistoricalFilters = (logType) => {
            const logState = state.logs[logType];
            if (!logState) return;
            
            const query = logState.query.toLowerCase();
            const serviceFilter = logState.serviceFilter;
            
            logState.filtered = logState.data.filter(log => {
                // User-level filtering
                if (config.authLevel === 'user') {
                    if (logType === 'gateway' && log.user !== config.identity.address) return false;
                    if (logType === 'ledger' && log.transaction_info?.from !== config.identity.address) return false;
                }
                
                // Service filtering (for gateway and schema logs)
                const serviceMatch = (
                    serviceFilter === 'all' || 
                    !serviceFilter || 
                    logType === 'admin' || 
                    logType === 'ledger' || 
                    (logType === 'schema' && log.schema_name === serviceFilter) || 
                    (logType === 'gateway' && serviceInGatewayLog(log, serviceFilter))
                );
                
                if (!serviceMatch) return false;
                
                // Keyword search
                if (!query) return true;
                
                // Search in all relevant fields
                const searchableText = JSON.stringify({
                    traceId: log.trace_id,
                    url: log.client_request?.url,
                    user: log.user,
                    activity: log.activity,
                    schemaName: log.schema_name,
                    failure: log.failure_message,
                    txId: log.transaction_info?.transactionId,
                    txType: log.transaction_info?.type
                }).toLowerCase();
                
                return searchableText.includes(query);
            });
            
            logState.currentPage = 1; // Reset to first page when filters change
            renderHistoricalLogs(logType);
        };

        const fetchHistoricalLogs = async (logType) => {
            const contentEl = document.getElementById(`${logType}-logs-content`);
            if (!contentEl) return;
            
            const logContainer = contentEl.querySelector('.historical-log-container');
            if (!logContainer) return;
            
            // Show loading state
            logContainer.innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="text-center">
                        <i data-lucide="loader-2" class="w-12 h-12 text-blue-500 animate-spin mx-auto mb-4"></i>
                        <p class="text-gray-600">Loading logs...</p>
                    </div>
                </div>`;
            lucide.createIcons();
            
            const timeframe = state.logs[logType].timeframe || '24h';
            const now = new Date();
            let start;
            switch (timeframe) {
                case '5m': start = new Date(now.getTime() - 5 * 60 * 1000); break;
                case '15m': start = new Date(now.getTime() - 15 * 60 * 1000); break;
                case '1h': start = new Date(now.getTime() - 60 * 60 * 1000); break;
                case '7d': start = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000); break;
                case '24h': default: start = new Date(now.getTime() - 24 * 60 * 60 * 1000); break;
            }
            
            const authType = (config.authLevel === 'admin') ? 'admin' : 'user';
            const logs = await apiFetch(`/logs/${logType}?start=${start.toISOString()}&end=${now.toISOString()}&max=5000`, { authType, method: 'GET' });
            
            if (!logs || logs.error) {
                logContainer.innerHTML = `
                    <div class="text-center p-12 text-gray-500">
                        <div class="text-3xl mb-4">${renderIcon('alert-circle')}</div>
                        Failed to load logs: ${logs?.message || 'Unknown error'}
                    </div>`;
                lucide.createIcons();
                return;
            }
            
            state.logs[logType].data = (logs || []).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            state.logs[logType].currentPage = 1; // Reset to first page on new fetch
            applyHistoricalFilters(logType);
        };

        // --- Core Logic ---
        const fetchAllData = async () => {
            const [services, pipelines, status, hardware] = await Promise.all([
                apiFetch('/services', { authType: 'public' }),
                apiFetch('/pipelines', { authType: 'public' }),
                apiFetch('/gateway-status', { authType: 'public' }),
                apiFetch('/hardware-stats', { authType: 'public' }),
            ]);
            
            if (!deepEqual(status, state.status)) { state.status = status; renderStatus(state.status); }
            if (!deepEqual(hardware, state.hardware)) { state.hardware = hardware; renderHardware(state.hardware); }
            if (!deepEqual(services, state.services)) { 
                state.services = services; 
                renderServices(state.services);
                populateServiceFilters();
            }
            if (!deepEqual(pipelines, state.pipelines)) { 
                state.pipelines = pipelines; 
                renderPipelines(state.pipelines);
                renderRegisteredWorkflows();
            }
        };
        
        const fetchMonitoredWorkflows = async () => {
            const { name, status, startDate } = state.monitoringFilters;
            const params = new URLSearchParams();
            if (name) params.set('workflowName', name);
            if (status) params.set('status', status);
            if (startDate) params.set('startDate', new Date(startDate).toISOString());
            
            const authType = config.authLevel;
            const endpoint = `/workflows/monitoring?${params.toString()}`;
            const monitored = await apiFetch(endpoint, { authType, method: 'GET' });
            
            let sortedMonitored = [];
            if (Array.isArray(monitored)) {
                sortedMonitored = monitored.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            } else {
                console.error("Received non-array response for monitored workflows:", monitored);
            }
            
            if (!deepEqual(state.workflows.monitored, sortedMonitored)) {
                state.workflows.monitored = sortedMonitored;
                renderFilteredMonitoredWorkflows();
            }
        };
        
        const populateServiceFilters = () => {
            const services = state.services;
            if (!services) return;
            const serviceNames = [...new Set(Object.values(services).flat().map(inst => inst.service))].sort();
            const optionsHTML = `<option value="all">All Services</option>` + serviceNames.map(name => `<option value="${name}">${name}</option>`).join('');
            document.querySelectorAll('.service-name-filter').forEach(select => {
                const logType = select.closest('.sub-tab-content')?.dataset.logType;
                if(logType && state.logs[logType]) {
                    const previousValue = state.logs[logType].serviceFilter || 'all';
                    select.innerHTML = optionsHTML;
                    select.value = previousValue; 
                }
            });
            const liveLogFilter = document.getElementById('live-log-service-filter');
            if (liveLogFilter) {
                liveLogFilter.innerHTML = optionsHTML;
                liveLogFilter.value = state.live.serviceFilter;
            }
        };

        const connectToLogStream = async () => {
            if (logSocket) logSocket.close();
            if (!config.identity || config.authLevel !== 'admin') return;

            const dataToSign = config.identity.address;
            const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(dataToSign));
            const signature = config.identity.key.sign(Array.from(new Uint8Array(hash)));
            const signatureHex = signature.toDER('hex');

            const wsProtocol = config.nodeUrl.startsWith('https') ? 'wss' : 'ws';
            const wsUrl = `${wsProtocol}://${config.nodeUrl.split('//')[1]}/admin/logs/live`;
            
            logSocket = new WebSocket(wsUrl);
            
            const logContainer = document.getElementById('live-log-container');
            if (logContainer) {
                logContainer.innerHTML = '';
                renderLogEntry({ log_type: 'system', failure_message: "Connecting to live log stream..."}, logContainer);
            }

            logSocket.onopen = () => {
                logSocket.send(JSON.stringify({
                    type: 'auth',
                    address: config.identity.address,
                    signature: signatureHex
                }));
                renderLogEntry({ log_type: 'system', failure_message: "Live log stream connected."}, logContainer);
            };
            logSocket.onmessage = (event) => {
                if (logContainer) {
                    try { renderLogEntry(JSON.parse(event.data), logContainer); } catch (e) { console.error("Error parsing log data:", e); }
                }
            };
            logSocket.onclose = (event) => {
                if (!sessionStorage.getItem('grapthwayConfig')) return; 
                 if (logContainer) {
                    const reason = event.reason || `code: ${event.code}`;
                    renderLogEntry({ log_type: 'system', failure_message: `Connection closed (${reason}). Reconnecting in 3s...`}, logContainer);
                }
                setTimeout(connectToLogStream, 3000);
            };
            logSocket.onerror = (error) => {
                console.error("WebSocket Error:", error);
                 if (logContainer) {
                    renderLogEntry({ log_type: 'system', failure_message: `Connection error. Check console.`}, logContainer);
                }
                logSocket.close();
            };
        };
        
        const login = async (nodeUrl, privateKey) => {
            config.nodeUrl = nodeUrl.trim().replace(/\/$/, '');
            config.privateKey = privateKey.trim();
            config.identity = await generateIdentityFromKey(config.privateKey);
            
            if (!config.nodeUrl || !config.identity) {
                alert("Invalid Node URL or Private Key.");
                return;
            }

            const authCheck = await apiFetch('/logs/admin', { authType: 'admin', method: 'GET' });

            if (authCheck && authCheck.error === 'network_failure') {
                alert("Could not connect to the node. Check the node URL and ensure it's running.");
                return;
            }
            
            if (authCheck && authCheck.error === 'admin_auth_failed') {
                config.authLevel = 'user';
                document.getElementById('auth-level-indicator').textContent = `Connected as User: ${config.identity.address}`;
            
            } else { 
                config.authLevel = 'admin';
                document.getElementById('auth-level-indicator').textContent = `Connected as Node Operator: ${config.identity.address}`;
            }

            sessionStorage.setItem('grapthwayConfig', JSON.stringify({ nodeUrl: config.nodeUrl, privateKey: config.privateKey }));
            startApp();
        };

        const startApp = () => {
            loginModal.classList.add('hidden');
            mainContent.classList.remove('hidden');
            
            renderTabs();
            
            fetchAllData();
            fetchInterval = setInterval(() => {
                fetchAllData();
                if (document.querySelector('.tab[data-tab="wallet"].active')) {
                    fetchWalletData();
                }
                if (document.querySelector('.tab[data-tab="workflows"].active')) {
                    fetchMonitoredWorkflows();
                }
            }, 5000);
            
            document.querySelector('.tab').click();
        };

        const showLoginModal = () => {
            clearInterval(fetchInterval);
            if(logSocket) { logSocket.onclose = null; logSocket.close(); }
            mainContent.classList.add('hidden');
            loginModal.classList.remove('hidden');
            document.getElementById('node-url').value = '';
            document.getElementById('private-key').value = '';
            lucide.createIcons();
        };
        
        const logout = () => {
            sessionStorage.removeItem('grapthwayConfig');
            config = { nodeUrl: '', privateKey: '', identity: null, authLevel: 'none' };
            showLoginModal();
        };

        document.addEventListener('DOMContentLoaded', async () => {
            loginModal = document.getElementById('login-modal');
            loginForm = document.getElementById('login-form');
            mainContent = document.getElementById('main-content');
            detailsModal = document.getElementById('details-modal');
            detailsModalContent = document.getElementById('details-modal-content');

            loginForm.addEventListener('submit', (e) => { e.preventDefault(); login(document.getElementById('node-url').value, document.getElementById('private-key').value); });
            document.getElementById('logout-button').addEventListener('click', logout);
            
            document.addEventListener('input', (e) => {
                const targetId = e.target.id;
                if (targetId === 'service-search') {
                    state.search.services = e.target.value;
                    renderFilteredServices();
                } else if (targetId === 'pipeline-search') {
                    state.search.pipelines = e.target.value;
                    renderFilteredPipelines();
                } else if (targetId === 'workflow-search') {
                    state.search.workflows = e.target.value;
                    renderFilteredRegisteredWorkflows();
                }
            });

            const savedConfig = sessionStorage.getItem('grapthwayConfig');
            if (savedConfig) {
                try {
                    const parsed = JSON.parse(savedConfig);
                    await login(parsed.nodeUrl, parsed.privateKey);
                } catch (e) { showLoginModal(); }
            } else { showLoginModal(); }
            lucide.createIcons();
        });
    </script>
    
</body>
</html>

